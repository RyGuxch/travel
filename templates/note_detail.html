<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ note.title }} - æ¸¸è®°è¯¦æƒ… - Travel Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <style>
        .note-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .note-header {
            margin-bottom: 24px;
            border-bottom: 1px solid #eee;
            padding-bottom: 16px;
        }
        .note-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #222;
            margin-bottom: 8px;
        }
        .note-meta {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 14px;
        }
        .note-time {
            font-style: italic;
        }
        .note-plan {
            background-color: #f8f9fa;
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .note-plan a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .note-content {
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }
        .note-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 16px 0;
        }
        .note-actions {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
        }
        /* è®¿é—®ç±»å‹ä¿¡æ¯æ ·å¼ */
        .access-info {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border: 1px solid #d0e2ff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        
        .access-info.owner {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4f1d4 100%);
            border-color: #b3d9b3;
            color: #1b5e20;
        }
        
        .access-info.public-shared {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b3 100%);
            border-color: #ffcc80;
            color: #e65100;
        }
        
        .access-info.friend-shared,
        .access-info.friend-access {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-color: #ce93d8;
            color: #4a148c;
        }
        
        .access-info.private-shared {
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
            border-color: #d0d0d0;
            color: #424242;
        }
        
        .access-info-icon {
            font-size: 18px;
            min-width: 18px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">ğŸŒ Travel Agent</a>
            <div class="nav-links">
                <a href="/">é¦–é¡µ</a>
                <a href="/plans">æˆ‘çš„è®¡åˆ’</a>
                <a href="/notes" class="active">æ¸¸è®°</a>
                <a href="/expenses">å¼€é”€</a>
                <a href="/moments">åŠ¨æ€</a>
                <a href="/friends">å¥½å‹</a>
                <a href="/about">å…³äº</a>
            </div>
            <div class="nav-user" id="navUserBox"></div>
        </div>
    </nav>
    
    <div class="main-container">
        <div class="note-container">
            <div class="note-header">
                <h1 class="note-title">{{ note.title }}</h1>
                <div class="note-meta">
                    <div class="note-time">åˆ›å»ºäº {{ note.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                    <div class="note-author">ä½œè€…: {{ plan.user.username }}</div>
                </div>
            </div>
            
            <div class="note-plan">
                <i class="fas fa-map-marked-alt"></i> æ¥è‡ªæ—…è¡Œè®¡åˆ’: {{ plan.title }}
            </div>
            
            <!-- è®¿é—®ç±»å‹ä¿¡æ¯ -->
            {% if access_type %}
            <div class="access-info {{ access_type }}">
                {% if access_type == 'owner' %}
                    <i class="access-info-icon fas fa-crown"></i>
                    <div>
                        <strong>æ‚¨æ˜¯æ­¤æ¸¸è®°çš„ä½œè€…</strong><br>
                        <small>æ‚¨å¯ä»¥ç¼–è¾‘ã€åˆ†äº«æˆ–åˆ é™¤æ­¤æ¸¸è®°</small>
                    </div>
                {% elif access_type == 'public_shared' %}
                    <i class="access-info-icon fas fa-globe"></i>
                    <div>
                        <strong>å…¬å¼€åˆ†äº«çš„æ¸¸è®°</strong><br>
                        <small>ç”± {{ shared_by }} åˆ†äº«åˆ°åŠ¨æ€ï¼Œæ‰€æœ‰äººå¯è§</small>
                    </div>
                {% elif access_type == 'friend_shared' %}
                    <i class="access-info-icon fas fa-users"></i>
                    <div>
                        <strong>å¥½å‹åˆ†äº«çš„æ¸¸è®°</strong><br>
                        <small>ç”± {{ shared_by }} åˆ†äº«åˆ°åŠ¨æ€ï¼Œä»…å¥½å‹å¯è§</small>
                    </div>
                {% elif access_type == 'private_shared' %}
                    <i class="access-info-icon fas fa-user-lock"></i>
                    <div>
                        <strong>ç§å¯†åˆ†äº«çš„æ¸¸è®°</strong><br>
                        <small>ç”± {{ shared_by }} åˆ†äº«ï¼Œä»…é™ä½œè€…æŸ¥çœ‹</small>
                    </div>
                {% elif access_type == 'friend_access' %}
                    <i class="access-info-icon fas fa-heart"></i>
                    <div>
                        <strong>å¥½å‹çš„æ¸¸è®°</strong><br>
                        <small>æ¥è‡ªæ‚¨çš„å¥½å‹ {{ owner_name }}ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ­¤å†…å®¹</small>
                    </div>
                {% endif %}
            </div>
            {% endif %}
            
            <div class="note-content" id="noteContent">
                <!-- è¿™é‡Œå°†æ˜¾ç¤ºæ¸¸è®°å†…å®¹ -->
            </div>
            
            <div class="note-actions">
                <a href="/notes" class="btn btn-outline"><i class="fas fa-arrow-left"></i> è¿”å›æ¸¸è®°åˆ—è¡¨</a>
                <div>
                    {% if is_owner %}
                    <button class="btn btn-outline" onclick="shareToMoments({{ note.id }})">
                        <i class="fas fa-share-alt"></i> åˆ†äº«åˆ°åŠ¨æ€
                    </button>
                    <button class="btn btn-primary" onclick="editNote({{ note.id }})">
                        <i class="fas fa-pen-to-square"></i> ç¼–è¾‘æ¸¸è®°
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script>
        // æ¸²æŸ“Markdownå†…å®¹
        document.addEventListener('DOMContentLoaded', function() {
            const content = `{{ note.content|safe }}`;
            document.getElementById('noteContent').innerHTML = marked.parse(content);
        });
        
        // æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯æ¡†
        function renderUserBox() {
            try {
                const navUserBox = document.getElementById('navUserBox');
                if (!navUserBox) {
                    console.error('æ‰¾ä¸åˆ°ç”¨æˆ·ä¿¡æ¯æ¡†å…ƒç´ ');
                    return;
                }

                fetch('/api/userinfo', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                })
                .then(r => {
                    if (!r.ok) throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                    return r.json();
                })
                .then(data => {
                    if (data.logged_in) {
                        navUserBox.innerHTML = `
                            <div style="display:flex; align-items:center;">
                                <a href="/profile" style="color: var(--text-primary); text-decoration: none; display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 8px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'" onmouseout="this.style.backgroundColor='transparent'">
                                <div class="avatar" style="width:32px; height:32px; font-size:14px; margin-right:8px;">${data.username[0].toUpperCase()}</div>
                                <span>${data.username}</span>
                                </a>
                                <button class='btn btn-small btn-outline' style="margin-left:12px;" onclick='logoutUser()'>ç™»å‡º</button>
                            </div>
                        `;
                    } else {
                        navUserBox.innerHTML = `<button class='btn btn-small btn-primary' onclick='showLoginModal()'>ç™»å½•</button>`;
                    }
                })
                .catch(err => {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
                    navUserBox.innerHTML = `<button class='btn btn-small btn-primary' onclick='window.location.reload()'>é‡è¯•</button>`;
                });
            } catch (error) {
                console.error('æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯æ¡†å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderUserBox();
        });
        
        // ç¼–è¾‘æ¸¸è®°åŠŸèƒ½
        window.editNote = function(noteId) {
            fetch(`/api/note/${noteId}`).then(r=>r.json()).then(note=>{
                showNoteModal(note);
            });
        }
        
        function showNoteModal(note) {
            let modal = document.createElement('div');
            modal.id = 'noteModal';
            modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;overflow:auto;';
            modal.innerHTML = `
            <div style='background:#fff;border-radius:16px;max-width:800px;width:96vw;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);max-height:96vh;overflow:auto;box-sizing:border-box;'>
                <h3 style='margin-bottom:12px;'>ç¼–è¾‘æ¸¸è®°</h3>
                <input id='noteTitle' class='form-input' style='margin-bottom:12px;' placeholder='æ¸¸è®°æ ‡é¢˜' value='${note.title}'>
                <textarea id='noteEditor' style='min-height:300px;'>${note.content}</textarea>
                <div style='margin:16px 0 0 0;text-align:right;'>
                    <button class='btn btn-outline' onclick='closeNoteModal()' style="margin-right:8px;">å–æ¶ˆ</button>
                    <button class='btn btn-primary' id='saveNoteBtn'>ä¿å­˜</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            
            setTimeout(()=>{
                window.notesMDE = new EasyMDE({
                    element: document.getElementById('noteEditor'),
                    autoDownloadFontAwesome: false,
                    spellChecker: false,
                    status: false,
                    minHeight: '300px',
                    toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "link", "image", "table", "|", "preview", "side-by-side", "fullscreen", "|", "guide"]
                });
            }, 10);
            
            document.getElementById('saveNoteBtn').onclick = function() {
                const title = document.getElementById('noteTitle').value.trim();
                const content = window.notesMDE.value();
                if(!title) { alert('è¯·è¾“å…¥æ ‡é¢˜'); return; }
                
                fetch(`/api/note/${note.id}`, {
                    method:'PUT',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({title, content, media:[]})
                }).then(r=>r.json()).then(d=>{
                    if(d.success) { 
                        closeNoteModal(); 
                        location.reload(); 
                    }
                    else alert('ä¿å­˜å¤±è´¥');
                });
            };
        }
        
        function closeNoteModal() {
            let modal = document.getElementById('noteModal');
            if(modal) { modal.remove(); }
        }
        
        // åˆ†äº«æ¸¸è®°åˆ°åŠ¨æ€åŠŸèƒ½
        window.shareToMoments = function(noteId) {
            fetch(`/api/note/${noteId}`).then(r=>r.json()).then(note=>{
                showShareModal(note);
            });
        }
        
        function showShareModal(note) {
            let modal = document.createElement('div');
            modal.id = 'shareModal';
            modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;overflow:auto;';
            modal.innerHTML = `
            <div style='background:#fff;border-radius:16px;max-width:520px;width:96vw;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);max-height:96vh;overflow:auto;box-sizing:border-box;'>
                <h3 style='margin-bottom:12px;'>åˆ†äº«åˆ°åŠ¨æ€</h3>
                <div style="margin-bottom:16px;">
                    <div style="font-weight:bold;margin-bottom:4px;">æ¸¸è®°æ ‡é¢˜ï¼š</div>
                    <div style="background:#f5f5f5;padding:8px;border-radius:8px;">${note.title}</div>
                </div>
                <div style="margin-bottom:16px;">
                    <textarea id="shareContent" class="form-input" placeholder="æ·»åŠ åˆ†äº«æ–‡å­—..." style="width:100%;min-height:100px;margin-bottom:8px;">#æ—…è¡Œæ¸¸è®°# åˆ†äº«æˆ‘çš„æ¸¸è®°ï¼šã€Š${note.title}ã€‹</textarea>
                    <div style="color:#888;font-size:13px;">æ¸¸è®°å†…å®¹å°†ä½œä¸ºæ‘˜è¦éšåŠ¨æ€ä¸€èµ·å‘å¸ƒ</div>
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block;margin-bottom:8px;">å¯è§æ€§ï¼š</label>
                    <select id="shareVisibility" class="form-input" style="width:100%;">
                        <option value="public">æ‰€æœ‰äººå¯è§</option>
                        <option value="friends">ä»…å¥½å‹å¯è§</option>
                        <option value="private">ä»…è‡ªå·±å¯è§</option>
                    </select>
                </div>
                <div style='margin:20px 0 0 0;text-align:right;'>
                    <button class='btn btn-outline' onclick='closeShareModal()' style="margin-right:8px;">å–æ¶ˆ</button>
                    <button class='btn btn-primary' id='confirmShareBtn'>å‘å¸ƒåˆ°åŠ¨æ€</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            
            // æˆªå–æ¸¸è®°å†…å®¹å‰200ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
            const contentPreview = note.content.length > 200 ? 
                note.content.substring(0, 200) + '...' : 
                note.content;
                
            document.getElementById('confirmShareBtn').onclick = function() {
                const content = document.getElementById('shareContent').value.trim();
                const visibility = document.getElementById('shareVisibility').value;
                
                if(!content) {
                    alert('è¯·è¾“å…¥åˆ†äº«å†…å®¹');
                    return;
                }
                
                // å‘å¸ƒåˆ°åŠ¨æ€çš„å†…å®¹æ ¼å¼
                const momentContent = `${content}\n\n---\n**æ¸¸è®°æ‘˜è¦**ï¼š${contentPreview}`;
                
                // è°ƒç”¨APIåˆ›å»ºæ–°åŠ¨æ€
                fetch('/api/moments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        content: momentContent,
                        media: [], // å¯ä»¥è€ƒè™‘å°†æ¸¸è®°ä¸­çš„å›¾ç‰‡ä¹Ÿä¸€èµ·åˆ†äº«
                        visibility: visibility,
                        note_id: note.id, // æ·»åŠ å…³è”çš„æ¸¸è®°ID
                        note_title: note.title
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if(result.success) {
                        closeShareModal();
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        const successMsg = document.createElement('div');
                        successMsg.style = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#34C759;color:white;border-radius:8px;padding:12px 24px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;display:flex;align-items:center;gap:8px;';
                        successMsg.innerHTML = `
                            <i class="fas fa-check-circle"></i> æ¸¸è®°å·²æˆåŠŸåˆ†äº«åˆ°åŠ¨æ€
                        `;
                        document.body.appendChild(successMsg);
                        
                        setTimeout(() => {
                            successMsg.style.opacity = '0';
                            successMsg.style.transition = 'opacity 0.5s, transform 0.5s';
                            successMsg.style.transform = 'translateX(-50%) translateY(-10px)';
                            setTimeout(() => {
                                successMsg.remove();
                            }, 500);
                        }, 2000);
                    } else {
                        alert('åˆ†äº«å¤±è´¥: ' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('åˆ†äº«å¤±è´¥:', error);
                    alert('åˆ†äº«å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            };
        }
        
        function closeShareModal() {
            let modal = document.getElementById('shareModal');
            if(modal) { 
                modal.remove(); 
            }
        }
        
        // ç™»å‡ºç”¨æˆ·
        window.logoutUser = function() {
            fetch('/api/logout', {
                method:'POST',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/';
                } else {
                    alert('ç™»å‡ºå¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(err => {
                console.error('ç™»å‡ºå¤±è´¥:', err);
                alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        };
        
        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        window.showLoginModal = function() {
            window.location.href = '/?login_required=1';
        };
    </script>
</body>
</html> 