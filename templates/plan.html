<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plan.title }} - Travel Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <!-- 高德地图API -->
    <script type="text/javascript" async defer src="https://webapi.amap.com/maps?v=2.0&key={{ config.AMAP_WEB_KEY }}&plugin=AMap.Scale,AMap.ToolBar,AMap.Driving"></script>
    <style>
    .note-content-md img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 8px 0;
        border-radius: 8px;
    }
    .note-content-md {
        max-height: 200px;
        overflow: hidden;
        position: relative;
        transition: max-height 0.3s;
        font-size: 1.08em;
        line-height: 1.7;
        color: #222;
        background: #fcfcfd;
        border-radius: 10px;
        padding: 10px 16px 10px 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .note-content-md.expanded {
        max-height: none;
    }
    .note-content-md .fade-mask {
        content: '';
        position: absolute;
        left: 0; right: 0; bottom: 0;
        height: 48px;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, #fff 90%);
        pointer-events: none;
        border-radius: 0 0 10px 10px;
    }
    .show-toggle-btn {
        display: flex;
        justify-content: flex-end;
        margin-top: -32px;
        margin-bottom: 8px;
        z-index: 2;
        position: relative;
    }
    .show-toggle-btn button {
        color: #007aff;
        background: none;
        border: none;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        padding: 2px 12px;
        border-radius: 6px;
        transition: background 0.15s;
    }
    .show-toggle-btn button:hover {
        background: #f0f4ff;
    }
    .card.note-card {
        box-shadow: 0 4px 18px rgba(0,0,0,0.08);
        border-radius: 16px;
        border: 1px solid #f2f2f2;
        padding: 22px 24px 18px 24px;
        margin-bottom: 24px;
        background: #fff;
        transition: box-shadow 0.2s;
    }
    .card.note-card:hover {
        box-shadow: 0 8px 32px rgba(0,0,0,0.13);
    }
    .note-title {
        font-size: 1.25em;
        font-weight: 700;
        color: #222;
        margin-bottom: 2px;
        letter-spacing: 0.5px;
    }
    .note-actions button {
        margin-left: 8px;
        border-radius: 6px;
        transition: background 0.15s, color 0.15s;
    }
    .note-actions button:hover {
        background: #f0f4ff;
        color: #007aff;
    }
    .note-time {
        color: #aaa;
        font-size: 13px;
        margin-top: 10px;
        text-align: right;
        letter-spacing: 0.2px;
    }
    @media (max-width: 600px) {
        .card.note-card { padding: 12px 6vw 12px 6vw; }
        .note-content-md { padding: 8px 4vw 8px 4vw; }
    }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">🌍 Travel Agent</a>
            <div class="nav-links">
                <a href="/">首页</a>
                <a href="/plans" class="active">我的计划</a>
                <a href="/notes">游记</a>
                <a href="/expenses">开销</a>
                <a href="/moments">动态</a>
                <a href="/friends">好友</a>
                <a href="/reports">报告</a>
                <a href="/about">关于</a>
                <button id="shareBtn" class="btn btn-secondary" onclick="showSharePlanModal()">分享计划</button>
            </div>
            <div class="nav-user" id="navUserBox"></div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="main-container">
        <!-- Apple风格顶部计划信息卡片 -->
        <div class="plan-header-apple">
            <div class="plan-header-main">
                <h1 class="plan-title">{{ plan.title }}</h1>
                <div class="plan-tags">
                    <span class="tag tag-primary">{{ plan.travel_theme }}</span>
                    <span class="tag tag-secondary">{{ plan.transport_mode }}</span>
                    {% if plan.ai_generated %}
                    <span class="tag tag-info">AI生成</span>
                    {% endif %}
                </div>
            </div>
            <div class="plan-header-info">
                <div>
                    <div class="info-label">出行日期</div>
                    <div class="info-value">{{ plan.start_date }} 至 {{ plan.end_date }}</div>
                </div>
                <div>
                    <div class="info-label">总天数</div>
                    <div class="info-value">{{ plan.total_days }}天</div>
                </div>
                <div>
                    <div class="info-label">预算范围</div>
                    <div class="info-value">¥{{ plan.budget_min }} - ¥{{ plan.budget_max }}</div>
                </div>
                <div>
                    <div class="info-label">计划状态</div>
                    <div class="info-value">
                        <span class="status-badge status-{{ plan.status }}">
                            {% if plan.status == 'draft' %}草稿{% elif plan.status == 'confirmed' %}已确认{% elif plan.status == 'completed' %}已完成{% endif %}
                        </span>
                        {% if plan.status == 'draft' %}
                        <button id="confirmPlanBtn" class="btn btn-small btn-success" style="margin-left:12px;">确认计划</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-layout">
            <!-- 地图区域 -->
            <div class="map-section">
                <div class="card map-card">
                    <div class="card-header">
                        <h3 class="title-medium">📍 行程地图</h3>
                        <div class="map-controls">
                            <button id="showRouteBtn" class="btn btn-small btn-primary">显示路线</button>
                            <button id="refreshRouteBtn" class="btn btn-small btn-outline">刷新路线</button>
                            <button id="fitViewBtn" class="btn btn-small btn-secondary">适应视图</button>
                        </div>
                    </div>
                    <div id="mapContainer" class="map-container"></div>
                    <div id="routeInfo" class="route-info-container"></div>
                </div>
            </div>

            <!-- 行程详情 -->
            <div class="itinerary-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="title-medium">📅 详细行程</h3>
                        <div class="itinerary-controls">
                            <button id="editBtn" class="btn btn-small btn-outline">编辑</button>
                            <button id="printBtn" class="btn btn-small btn-outline" onclick="printPlan()">打印</button>
                            <button id="deleteBtn" class="btn btn-small btn-outline btn-danger">删除</button>
                        </div>
                    </div>
                    
                    <div class="itinerary-content">
                        <div id="itineraryTimeline" class="timeline">
                            <!-- 动态加载行程内容 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="stats-section">
            <div class="card">
                <h3 class="title-medium">📊 行程统计</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCost">-</div>
                        <div class="stat-label">总费用</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalDistance">-</div>
                        <div class="stat-label">总距离</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalLocations">-</div>
                        <div class="stat-label">地点数量</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgDailyCost">-</div>
                        <div class="stat-label">日均费用</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 游记卡片 -->
        <div class="card" id="travelNotesSection">
            <div class="card-header">
                <h3 class="title-medium">📝 游记记录</h3>
                <button class="btn btn-primary" id="addNoteBtn">新增游记</button>
            </div>
            <div id="notesList"></div>
        </div>
    </div>

    <!-- 加载中遮罩 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>正在加载地图数据...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 传递计划ID给JS
        window.PLAN_ID = parseInt("{{ plan.id }}");
        
        // 当地图加载失败时的处理
        window.addEventListener('error', function(event) {
            if (event.target.src && event.target.src.includes('amap')) {
                console.error('高德地图API加载失败');
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #666; background-color: #f5f5f5; border-radius: 8px;">
                            <h3>🗺️ 地图加载失败</h3>
                            <p>无法加载高德地图API</p>
                            <p>请检查网络连接或API密钥配置</p>
                        </div>
                    `;
                }
            }
        }, true);
        
        // 登录相关功能
        function renderUserBox() {
            fetch('/api/userinfo', {
                credentials: 'include'
            }).then(r=>r.json()).then(data=>{
                const box = document.getElementById('navUserBox');
                if(data.logged_in) {
                    box.innerHTML = `<span style='margin-right:12px;'>👤 ${data.username}</span><button class='btn btn-small btn-outline' onclick='logoutUser()'>登出</button>`;
                } else {
                    box.innerHTML = `<button class='btn btn-small btn-primary' onclick='showLoginModal()'>登录</button>`;
                }
            });
        }
        
        function showLoginModal(message) {
            let modal = document.getElementById('loginModal');
            if(!modal) {
                modal = document.createElement('div');
                modal.id = 'loginModal';
                modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;';
                
                var htmlContent = '<div id="loginBox" style="background:#fff;border-radius:16px;max-width:340px;width:92vw;padding:28px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);">';
                htmlContent += '<h3 style="margin-bottom:18px;">用户登录</h3>';
                
                if(message) {
                    htmlContent += '<div style="color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;">' + message + '</div>';
                }
                
                htmlContent += '<input id="loginUsername" class="form-input" style="margin-bottom:12px;" placeholder="用户名">';
                htmlContent += '<input id="loginPassword" class="form-input" type="password" style="margin-bottom:18px;" placeholder="密码">';
                htmlContent += '<div style="text-align:right;">';
                htmlContent += '<button class="btn btn-outline" onclick="closeLoginModal()">取消</button>';
                htmlContent += '<button class="btn btn-primary" onclick="loginUser()">登录</button>';
                htmlContent += '<button class="btn btn-link" style="margin-left:8px;" onclick="showRegisterBox()">注册</button>';
                htmlContent += '</div>';
                htmlContent += '<div id="loginMsg" style="color:#d00;font-size:13px;margin-top:10px;"></div>';
                htmlContent += '</div>';
                
                modal.innerHTML = htmlContent;
                document.body.appendChild(modal);
            } else if (message) {
                // 如果弹窗已存在但需要显示错误信息
                const loginBox = document.getElementById('loginBox');
                if (loginBox && !document.getElementById('loginErrorMsg')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'loginErrorMsg';
                    errorDiv.style = 'color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;';
                    errorDiv.textContent = message;
                    loginBox.insertBefore(errorDiv, loginBox.firstChild.nextSibling);
                }
            }
            modal.style.display = 'flex';
        }
        
        function showRegisterBox() {
            const box = document.getElementById('loginBox');
            if(box) {
                box.innerHTML = `
                    <h3 style='margin-bottom:18px;'>用户注册</h3>
                    <input id='regUsername' class='form-input' style='margin-bottom:12px;' placeholder='用户名'>
                    <input id='regPassword' class='form-input' type='password' style='margin-bottom:12px;' placeholder='密码'>
                    <input id='regPassword2' class='form-input' type='password' style='margin-bottom:18px;' placeholder='重复密码'>
                    <div style='text-align:right;'>
                        <button class='btn btn-outline' onclick='closeLoginModal()'>取消</button>
                        <button class='btn btn-primary' onclick='registerUser()'>注册</button>
                        <button class='btn btn-link' style='margin-left:8px;' onclick='showLoginBox()'>返回登录</button>
                    </div>
                    <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
                `;
            }
        }
        
        function showLoginBox() {
            const box = document.getElementById('loginBox');
            if(box) {
                box.innerHTML = `
                    <h3 style='margin-bottom:18px;'>用户登录</h3>
                    <input id='loginUsername' class='form-input' style='margin-bottom:12px;' placeholder='用户名'>
                    <input id='loginPassword' class='form-input' type='password' style='margin-bottom:18px;' placeholder='密码'>
                    <div style='text-align:right;'>
                        <button class='btn btn-outline' onclick='closeLoginModal()'>取消</button>
                        <button class='btn btn-primary' onclick='loginUser()'>登录</button>
                        <button class='btn btn-link' style='margin-left:8px;' onclick='showRegisterBox()'>注册</button>
                    </div>
                    <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
                `;
            }
        }
        
        function closeLoginModal() {
            let modal = document.getElementById('loginModal');
            if(modal) modal.remove();
        }
        
        function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            fetch('/api/login', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials: 'include',
                body:JSON.stringify({username,password})
            }).then(r=>r.json()).then(d=>{
                if(d.success) { 
                    closeLoginModal(); 
                    // 如果URL中有login_required参数，移除它并重新加载
                    if (window.location.search.includes('login_required=1')) {
                        const url = new URL(window.location.href);
                        url.searchParams.delete('login_required');
                        window.location.href = url.toString();
                    } else {
                        location.reload(); 
                    }
                }
                else document.getElementById('loginMsg').textContent = d.msg||'登录失败';
            });
        }
        
        function logoutUser() {
            fetch('/api/logout', {
                method:'POST',
                credentials: 'include'
            }).then(()=>location.reload());
        }
        
        function registerUser() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const password2 = document.getElementById('regPassword2').value;
            if(!username || !password) { document.getElementById('loginMsg').textContent = '用户名和密码不能为空'; return; }
            if(password !== password2) { document.getElementById('loginMsg').textContent = '两次密码不一致'; return; }
            fetch('/api/register', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials: 'include',
                body:JSON.stringify({username,password})
            }).then(r=>r.json()).then(d=>{
                if(d.success) {
                    // 注册成功自动登录
                    fetch('/api/login', {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        credentials: 'include',
                        body:JSON.stringify({username,password})
                    }).then(r=>r.json()).then(d2=>{
                        if(d2.success) { 
                            closeLoginModal();
                            // 如果URL中有login_required参数，移除它并重新加载
                            if (window.location.search.includes('login_required=1')) {
                                const url = new URL(window.location.href);
                                url.searchParams.delete('login_required');
                                window.location.href = url.toString();
                            } else {
                                location.reload(); 
                            }
                        }
                        else document.getElementById('loginMsg').textContent = '注册成功但自动登录失败';
                    });
                } else {
                    document.getElementById('loginMsg').textContent = d.msg||'注册失败';
                }
            });
        }
        
        // 初始化时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            renderUserBox();
            
            // 检查URL参数，如果需要登录则显示登录窗口
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('login_required') === '1') {
                showLoginModal('请登录后再访问此页面');
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>
    <script src="{{ url_for('static', filename='js/plan.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var btn = document.getElementById('confirmPlanBtn');
        if (btn) {
            btn.addEventListener('click', function() {
                btn.disabled = true;
                btn.textContent = '正在确认...';
                fetch(`/api/plan/${window.PLAN_ID}/confirm`, {method: 'POST'})
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.message || '确认失败');
                            btn.disabled = false;
                            btn.textContent = '确认计划';
                        }
                    })
                    .catch(() => {
                        alert('网络错误，确认失败');
                        btn.disabled = false;
                        btn.textContent = '确认计划';
                    });
            });
        }
    });

    // 游记功能
    let notesMDE = null;
    function renderNotes() {
        fetch(`/api/plan/${window.PLAN_ID}/notes`).then(r=>r.json()).then(notes=>{
            const list = document.getElementById('notesList');
            if(!notes.length) { list.innerHTML = '<p style="color:#888">暂无游记，快来记录你的旅程吧！</p>'; return; }
            list.innerHTML = notes.map((note, idx) => {
                const contentHtml = marked.parse(note.content||'');
                return `
                    <div class='card note-card'>
                        <div style='display:flex;justify-content:space-between;align-items:center;'>
                            <div class='note-title'>${note.title}</div>
                            <div class='note-actions'>
                                <button class='btn btn-small btn-outline' onclick='editNote(${note.id})'><i class="fas fa-pen-to-square"></i> 编辑</button>
                                <button class='btn btn-small btn-danger' onclick='deleteNote(${note.id})'><i class="fas fa-trash-alt"></i> 删除</button>
                            </div>
                        </div>
                        <hr style='border:none;border-top:1px solid #f2f2f2;margin:10px 0 12px 0;'>
                        <div style='margin:10px 0; position:relative;'>
                            <div class='note-content-md' id='noteContent${idx}'>${contentHtml}</div>
                            <div class='fade-mask' id='fadeMask${idx}'></div>
                        </div>
                        <div class='show-toggle-btn'><button id='toggleBtn${idx}' onclick='toggleNoteContent(${idx})'>展开</button></div>
                        <div style='display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;'>
                            ${(note.media||[]).map(url=>url.match(/(jpg|jpeg|png|gif)$/i)?`<img src='${url}' style='max-width:120px;border-radius:8px;'>`:`<video src='${url}' controls style='max-width:160px;border-radius:8px;'></video>`).join('')}
                        </div>
                        <div class='note-time'>${note.created_at.replace('T',' ').slice(0,16)}</div>
                    </div>
                `;
            }).join('');
        });
    }
    function showNoteModal(note) {
        let modal = document.getElementById('noteModal');
        if(!modal) {
            modal = document.createElement('div');
            modal.id = 'noteModal';
            modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;overflow:auto;';
            modal.innerHTML = `
            <div style='background:#fff;border-radius:16px;max-width:520px;width:96vw;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);max-height:96vh;overflow:auto;box-sizing:border-box;'>
                <h3 style='margin-bottom:12px;'>${note&&note.id?'编辑':'新增'}游记</h3>
                <input id='noteTitle' class='form-input' style='margin-bottom:12px;' placeholder='游记标题' value='${note?note.title:''}'>
                <textarea id='noteEditor' style='min-height:120px;max-height:40vh;background:#fafbfc;margin-bottom:12px;'>${note?note.content||'':''}</textarea>
                <div style='margin-bottom:12px;'>
                    <input type='file' id='noteFileInput' accept='image/*,video/*' style='display:none;'>
                    <button class='btn btn-outline' id='uploadFileBtn' type='button'>上传图片/视频</button>
                    <span id='uploadStatus' style='color:#888;font-size:12px;margin-left:8px;'></span>
                </div>
                <div style='margin:12px 0 0 0;text-align:right;'>
                    <button class='btn btn-outline' onclick='closeNoteModal()'>取消</button>
                    <button class='btn btn-primary' id='saveNoteBtn'>保存</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        }
        modal.style.display = 'flex';
        setTimeout(()=>{
            notesMDE = new EasyMDE({
                element: document.getElementById('noteEditor'),
                autoDownloadFontAwesome: false,
                spellChecker: false,
                status: false,
                minHeight: '180px',
                toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "link", "image", "table", "preview", "side-by-side", "fullscreen", "guide"]
            });
            
            // 如果是编辑模式，设置编辑器内容
            if(note && note.content) {
                notesMDE.value(note.content);
            }
            
            // 上传按钮逻辑
            document.getElementById('uploadFileBtn').onclick = function() {
                document.getElementById('noteFileInput').click();
            };
            document.getElementById('noteFileInput').onchange = function(e) {
                const file = e.target.files[0];
                if(!file) return;
                const status = document.getElementById('uploadStatus');
                status.textContent = '上传中...';
                const formData = new FormData();
                formData.append('file', file);
                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                }).then(r=>r.json()).then(res=>{
                    if(res.success && res.url) {
                        status.textContent = '上传成功';
                        // 判断图片/视频，插入markdown
                        let insertText = '';
                        if(file.type.startsWith('image/')) {
                            insertText = `![](${res.url})`;
                        } else if(file.type.startsWith('video/')) {
                            insertText = `\n[视频](${res.url})\n`;
                        }
                        if(insertText) {
                            const cm = notesMDE.codemirror;
                            const doc = cm.getDoc();
                            doc.replaceSelection(insertText);
                        }
                    } else {
                        status.textContent = '上传失败';
                    }
                }).catch(()=>{
                    status.textContent = '上传失败';
                });
            };
        }, 10);
        document.getElementById('saveNoteBtn').onclick = function() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = notesMDE.value();
            if(!title) { alert('请输入标题'); return; }
            const method = note&&note.id?'PUT':'POST';
            const url = note&&note.id?`/api/note/${note.id}`:`/api/plan/${window.PLAN_ID}/notes`;
            fetch(url, {
                method,
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({title,content})
            }).then(r=>r.json()).then(d=>{
                if(d.success) { closeNoteModal(); renderNotes(); }
                else alert('保存失败');
            });
        };
    }
    function closeNoteModal() {
        let modal = document.getElementById('noteModal');
        if(modal) { 
            modal.style.display='none'; 
            modal.remove();
            // 清理编辑器实例
            if(notesMDE) {
                notesMDE.toTextArea();
                notesMDE = null;
            }
        }
    }
    function editNote(id) {
        fetch(`/api/note/${id}`).then(r=>r.json()).then(note=>{
            if(note.id) {
            showNoteModal(note);
            } else {
                alert('获取游记内容失败');
            }
        }).catch(error => {
            console.error('获取游记失败:', error);
            alert('获取游记内容失败，请重试');
        });
    }
    function deleteNote(id) {
        if(!confirm('确定要删除这篇游记吗？')) return;
        fetch(`/api/note/${id}`,{method:'DELETE'}).then(r=>r.json()).then(d=>{if(d.success)renderNotes();else alert('删除失败');});
    }
    document.getElementById('addNoteBtn').onclick = ()=>showNoteModal();
    renderNotes();

    // 添加JS折叠/展开逻辑
    window.toggleNoteContent = function(idx) {
        const content = document.getElementById('noteContent'+idx);
        const mask = document.getElementById('fadeMask'+idx);
        const btn = document.getElementById('toggleBtn'+idx);
        if(content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            mask.style.display = '';
            btn.textContent = '展开';
        } else {
            content.classList.add('expanded');
            mask.style.display = 'none';
            btn.textContent = '收起';
        }
    }

    // 渲染后自动判断内容高度，决定是否显示遮罩和按钮
    setTimeout(()=>{
        document.querySelectorAll('.note-content-md').forEach((el, idx)=>{
            const mask = document.getElementById('fadeMask'+idx);
            const btn = document.getElementById('toggleBtn'+idx);
            if(el.scrollHeight <= 210) {
                if(mask) mask.style.display = 'none';
                if(btn) btn.style.display = 'none';
            } else {
                if(mask) mask.style.display = '';
                if(btn) btn.style.display = '';
            }
        });
    }, 100);

    // 分享计划功能
    function showSharePlanModal() {
        const modal = document.createElement('div');
        modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;overflow:auto;';
        modal.innerHTML = `
        <div style='background:var(--apple-system-background, #fff);border-radius:16px;max-width:520px;width:96vw;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);max-height:96vh;overflow:auto;box-sizing:border-box;'>
            <h3 style='margin-bottom:16px;color:var(--apple-label, #000);'>分享旅行计划</h3>
            <p style='color:var(--apple-secondary-label, #666);margin-bottom:20px;'>将您的旅行计划分享到动态，让好友了解您的精彩行程。</p>
            <div style="margin-bottom:16px;">
                <textarea id="shareText" class="form-input" placeholder="添加分享文字..." style="width:100%;min-height:80px;margin-bottom:8px;">#旅行计划# 我的精彩行程安排，一起来看看吧！✈️</textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;color:var(--apple-label, #000);">可见性：</label>
                <select id="shareVisibility" class="form-input" style="width:100%;">
                    <option value="public">所有人可见</option>
                    <option value="friends">仅好友可见</option>
                    <option value="private">仅自己可见</option>
                </select>
            </div>
            <div style="margin-bottom:20px;padding:12px;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;margin-bottom:8px;">
                    <input type="checkbox" id="includeShareLink" checked style="margin-right:8px;">
                    <label for="includeShareLink" style="color:var(--apple-label, #000);font-size:14px;">包含分享链接</label>
                </div>
                <div style="font-size:12px;color:var(--apple-secondary-label, #666);">
                    选中后将生成可公开访问的计划链接，任何人都可以通过链接查看您的计划详情
                </div>
            </div>
            <div style='text-align:right;'>
                <button class='btn btn-outline' onclick='closePlanShareModal()' style="margin-right:8px;">取消</button>
                <button class='btn btn-primary' onclick='confirmSharePlan()'>分享到动态</button>
            </div>
        </div>`;
        
        modal.onclick = function(e) {
            if (e.target === modal) closePlanShareModal();
        };
        
        document.body.appendChild(modal);
        modal.id = 'planShareModal';
    }

    function confirmSharePlan() {
        const shareText = document.getElementById('shareText').value.trim();
        const visibility = document.getElementById('shareVisibility').value;
        const includeLink = document.getElementById('includeShareLink').checked;
        
        if (!shareText) {
            alert('请输入分享内容');
            return;
        }
        
        // 显示分享按钮为加载状态
        const shareBtn = document.querySelector('#planShareModal .btn-primary');
        const originalText = shareBtn.textContent;
        shareBtn.disabled = true;
        shareBtn.textContent = '正在分享...';
        
        // 构建分享流程
        let sharePromise;
        
        if (includeLink) {
            // 先生成分享链接，再分享
            sharePromise = fetch(`/api/plan/${window.PLAN_ID}/share-link`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(linkData => {
                if (linkData.success) {
                    // 获取当前计划信息并包含分享链接
                    return fetch(`/api/plan/${window.PLAN_ID}`, {
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(planData => {
                        const planSummary = `
📅 出行时间：${planData.start_date} 至 ${planData.end_date} (${planData.total_days}天)
🎯 旅行主题：${planData.travel_theme}
🚗 出行方式：${planData.transport_mode}
💰 预算范围：¥${planData.budget_min} - ¥${planData.budget_max}

🔗 查看完整计划：${linkData.share_url}`;
                        
                        const momentContent = `${shareText}\n\n---\n**计划详情**：\n${planSummary}`;
                        
                        return fetch('/api/moments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                content: momentContent,
                                media: [],
                                visibility: visibility
                            })
                        });
                    });
                } else {
                    throw new Error(linkData.msg || '生成分享链接失败');
                }
            });
        } else {
            // 不包含链接，只分享计划摘要
            sharePromise = fetch(`/api/plan/${window.PLAN_ID}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(planData => {
                const planSummary = `
📅 出行时间：${planData.start_date} 至 ${planData.end_date} (${planData.total_days}天)
🎯 旅行主题：${planData.travel_theme}
🚗 出行方式：${planData.transport_mode}
💰 预算范围：¥${planData.budget_min} - ¥${planData.budget_max}`;
                
                const momentContent = `${shareText}\n\n---\n**计划详情**：\n${planSummary}`;
                
                return fetch('/api/moments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        content: momentContent,
                        media: [],
                        visibility: visibility
                    })
                });
            });
        }
        
        sharePromise
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    closePlanShareModal();
                    if (includeLink) {
                        showToast('计划已成功分享到动态，包含公开访问链接！', 'success');
                    } else {
                        showToast('计划已成功分享到动态！', 'success');
                    }
                } else {
                    alert('分享失败: ' + (result.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('分享失败:', error);
                alert('分享失败，请稍后重试');
            })
            .finally(() => {
                // 恢复按钮状态
                shareBtn.disabled = false;
                shareBtn.textContent = originalText;
            });
    }

    function closePlanShareModal() {
        const modal = document.getElementById('planShareModal');
        if (modal) modal.remove();
    }

    // 打印计划功能
    function printPlan() {
        // 获取计划数据
        fetch(`/api/plan/${window.PLAN_ID}`)
            .then(response => response.json())
            .then(planData => {
                const printWindow = window.open('', '_blank');
                const printContent = generatePrintContent(planData);
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // 等待内容加载完成后打印
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                };
            })
            .catch(error => {
                console.error('获取计划数据失败:', error);
                alert('获取计划数据失败，无法打印');
            });
    }

    function generatePrintContent(planData) {
        // 格式化行程内容
        let itineraryHtml = '';
        if (planData.itineraries && planData.itineraries.length > 0) {
            itineraryHtml = planData.itineraries.map(day => {
                let itemsHtml = '';
                if (day.items && day.items.length > 0) {
                    itemsHtml = day.items.map(item => `
                        <div style="margin-bottom: 12px; padding: 8px; background: #f9f9f9; border-radius: 6px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                ${item.start_time} - ${item.title}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 2px;">
                                📍 ${item.location || '未设置地点'}
                            </div>
                            ${item.description ? `<div style="color: #666; font-size: 14px;">${item.description}</div>` : ''}
                            ${item.estimated_cost > 0 ? `<div style="color: #007AFF; font-size: 14px; font-weight: 500;">💰 预估费用: ¥${item.estimated_cost}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    itemsHtml = '<div style="color: #999; font-style: italic;">暂无具体安排</div>';
                }

                return `
                    <div style="margin-bottom: 24px; page-break-inside: avoid;">
                        <h3 style="color: #007AFF; border-bottom: 2px solid #007AFF; padding-bottom: 6px; margin-bottom: 12px;">
                            第${day.day_number}天 - ${day.date} ${day.theme ? `(${day.theme})` : ''}
                        </h3>
                        ${itemsHtml}
                    </div>
                `;
            }).join('');
        } else {
            itineraryHtml = '<div style="color: #999; font-style: italic; text-align: center; padding: 20px;">暂无行程安排</div>';
        }

        return `
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <title>旅行计划 - ${planData.title}</title>
            <style>
                @media print {
                    @page { margin: 1.5cm; }
                    body { -webkit-print-color-adjust: exact; }
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }
                .header {
                    text-align: center;
                    border-bottom: 3px solid #007AFF;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .title {
                    font-size: 28px;
                    font-weight: 700;
                    color: #007AFF;
                    margin-bottom: 10px;
                }
                .info-grid {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 20px;
                    margin-bottom: 30px;
                    justify-content: center;
                }
                .info-item {
                    background: #f8f9fa;
                    padding: 12px 16px;
                    border-radius: 8px;
                    min-width: 150px;
                    text-align: center;
                }
                .info-label {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 4px;
                }
                .info-value {
                    font-size: 16px;
                    font-weight: 600;
                    color: #333;
                }
                .section-title {
                    font-size: 20px;
                    font-weight: 600;
                    color: #333;
                    margin: 30px 0 15px 0;
                    border-left: 4px solid #007AFF;
                    padding-left: 12px;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    text-align: center;
                    color: #666;
                    font-size: 14px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="title">${planData.title}</div>
                <div style="color: #666; font-size: 16px;">旅行计划详情</div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">出行日期</div>
                    <div class="info-value">${planData.start_date} 至 ${planData.end_date}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">总天数</div>
                    <div class="info-value">${planData.total_days}天</div>
                </div>
                <div class="info-item">
                    <div class="info-label">旅行主题</div>
                    <div class="info-value">${planData.travel_theme}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">出行方式</div>
                    <div class="info-value">${planData.transport_mode}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">预算范围</div>
                    <div class="info-value">¥${planData.budget_min} - ¥${planData.budget_max}</div>
                </div>
            </div>

            <div class="section-title">📅 详细行程安排</div>
            ${itineraryHtml}

            <div class="footer">
                <div>此计划由 Travel Agent 智能旅行助手生成</div>
                <div>打印时间：${new Date().toLocaleString('zh-CN')}</div>
            </div>
        </body>
        </html>
        `;
    }

    // 通用提示函数
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s;
        `;
        
        if (type === 'success') {
            toast.style.background = '#34C759';
            toast.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                ${message}
            `;
        } else if (type === 'error') {
            toast.style.background = '#FF3B30';
            toast.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                ${message}
            `;
        }
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    </script>
</body>
</html> 
