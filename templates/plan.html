<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plan.title }} - Travel Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <!-- é«˜å¾·åœ°å›¾API -->
    <script type="text/javascript" async defer src="https://webapi.amap.com/maps?v=2.0&key={{ config.AMAP_WEB_KEY }}&plugin=AMap.Scale,AMap.ToolBar,AMap.Driving"></script>
    <style>
    .note-content-md img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 8px 0;
        border-radius: 8px;
    }
    .note-content-md {
        max-height: 200px;
        overflow: hidden;
        position: relative;
        transition: max-height 0.3s;
        font-size: 1.08em;
        line-height: 1.7;
        color: #222;
        background: #fcfcfd;
        border-radius: 10px;
        padding: 10px 16px 10px 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .note-content-md.expanded {
        max-height: none;
    }
    .note-content-md .fade-mask {
        content: '';
        position: absolute;
        left: 0; right: 0; bottom: 0;
        height: 48px;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, #fff 90%);
        pointer-events: none;
        border-radius: 0 0 10px 10px;
    }
    .show-toggle-btn {
        display: flex;
        justify-content: flex-end;
        margin-top: -32px;
        margin-bottom: 8px;
        z-index: 2;
        position: relative;
    }
    .show-toggle-btn button {
        color: #007aff;
        background: none;
        border: none;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        padding: 2px 12px;
        border-radius: 6px;
        transition: background 0.15s;
    }
    .show-toggle-btn button:hover {
        background: #f0f4ff;
    }
    .card.note-card {
        box-shadow: 0 4px 18px rgba(0,0,0,0.08);
        border-radius: 16px;
        border: 1px solid #f2f2f2;
        padding: 22px 24px 18px 24px;
        margin-bottom: 24px;
        background: #fff;
        transition: box-shadow 0.2s;
    }
    .card.note-card:hover {
        box-shadow: 0 8px 32px rgba(0,0,0,0.13);
    }
    .note-title {
        font-size: 1.25em;
        font-weight: 700;
        color: #222;
        margin-bottom: 2px;
        letter-spacing: 0.5px;
    }
    .note-actions button {
        margin-left: 8px;
        border-radius: 6px;
        transition: background 0.15s, color 0.15s;
    }
    .note-actions button:hover {
        background: #f0f4ff;
        color: #007aff;
    }
    .note-time {
        color: #aaa;
        font-size: 13px;
        margin-top: 10px;
        text-align: right;
        letter-spacing: 0.2px;
    }
    @media (max-width: 600px) {
        .card.note-card { padding: 12px 6vw 12px 6vw; }
        .note-content-md { padding: 8px 4vw 8px 4vw; }
    }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">ğŸŒ Travel Agent</a>
            <div class="nav-links">
                <a href="/">é¦–é¡µ</a>
                <a href="/plans" class="active">æˆ‘çš„è®¡åˆ’</a>
                <a href="/notes">æ¸¸è®°</a>
                <a href="/expenses">å¼€é”€</a>
                <a href="/moments">åŠ¨æ€</a>
                <a href="/friends">å¥½å‹</a>
                <a href="/reports">æŠ¥å‘Š</a>
                <a href="/about">å…³äº</a>
                <button id="shareBtn" class="btn btn-secondary" onclick="showSharePlanModal()">åˆ†äº«è®¡åˆ’</button>
            </div>
            <div class="nav-user" id="navUserBox"></div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-container">
        <!-- Appleé£æ ¼é¡¶éƒ¨è®¡åˆ’ä¿¡æ¯å¡ç‰‡ -->
        <div class="plan-header-apple">
            <div class="plan-header-main">
                <h1 class="plan-title">{{ plan.title }}</h1>
                <div class="plan-tags">
                    <span class="tag tag-primary">{{ plan.travel_theme }}</span>
                    <span class="tag tag-secondary">{{ plan.transport_mode }}</span>
                    {% if plan.ai_generated %}
                    <span class="tag tag-info">AIç”Ÿæˆ</span>
                    {% endif %}
                </div>
            </div>
            <div class="plan-header-info">
                <div>
                    <div class="info-label">å‡ºè¡Œæ—¥æœŸ</div>
                    <div class="info-value">{{ plan.start_date }} è‡³ {{ plan.end_date }}</div>
                </div>
                <div>
                    <div class="info-label">æ€»å¤©æ•°</div>
                    <div class="info-value">{{ plan.total_days }}å¤©</div>
                </div>
                <div>
                    <div class="info-label">é¢„ç®—èŒƒå›´</div>
                    <div class="info-value">Â¥{{ plan.budget_min }} - Â¥{{ plan.budget_max }}</div>
                </div>
                <div>
                    <div class="info-label">è®¡åˆ’çŠ¶æ€</div>
                    <div class="info-value">
                        <span class="status-badge status-{{ plan.status }}">
                            {% if plan.status == 'draft' %}è‰ç¨¿{% elif plan.status == 'confirmed' %}å·²ç¡®è®¤{% elif plan.status == 'completed' %}å·²å®Œæˆ{% endif %}
                        </span>
                        {% if plan.status == 'draft' %}
                        <button id="confirmPlanBtn" class="btn btn-small btn-success" style="margin-left:12px;">ç¡®è®¤è®¡åˆ’</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-layout">
            <!-- åœ°å›¾åŒºåŸŸ -->
            <div class="map-section">
                <div class="card map-card">
                    <div class="card-header">
                        <h3 class="title-medium">ğŸ“ è¡Œç¨‹åœ°å›¾</h3>
                        <div class="map-controls">
                            <button id="showRouteBtn" class="btn btn-small btn-primary">æ˜¾ç¤ºè·¯çº¿</button>
                            <button id="refreshRouteBtn" class="btn btn-small btn-outline">åˆ·æ–°è·¯çº¿</button>
                            <button id="fitViewBtn" class="btn btn-small btn-secondary">é€‚åº”è§†å›¾</button>
                        </div>
                    </div>
                    <div id="mapContainer" class="map-container"></div>
                    <div id="routeInfo" class="route-info-container"></div>
                </div>
            </div>

            <!-- è¡Œç¨‹è¯¦æƒ… -->
            <div class="itinerary-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="title-medium">ğŸ“… è¯¦ç»†è¡Œç¨‹</h3>
                        <div class="itinerary-controls">
                            <button id="editBtn" class="btn btn-small btn-outline">ç¼–è¾‘</button>
                            <button id="printBtn" class="btn btn-small btn-outline" onclick="printPlan()">æ‰“å°</button>
                            <button id="deleteBtn" class="btn btn-small btn-outline btn-danger">åˆ é™¤</button>
                        </div>
                    </div>
                    
                    <div class="itinerary-content">
                        <div id="itineraryTimeline" class="timeline">
                            <!-- åŠ¨æ€åŠ è½½è¡Œç¨‹å†…å®¹ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-section">
            <div class="card">
                <h3 class="title-medium">ğŸ“Š è¡Œç¨‹ç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCost">-</div>
                        <div class="stat-label">æ€»è´¹ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalDistance">-</div>
                        <div class="stat-label">æ€»è·ç¦»</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalLocations">-</div>
                        <div class="stat-label">åœ°ç‚¹æ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgDailyCost">-</div>
                        <div class="stat-label">æ—¥å‡è´¹ç”¨</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸è®°å¡ç‰‡ -->
        <div class="card" id="travelNotesSection">
            <div class="card-header">
                <h3 class="title-medium">ğŸ“ æ¸¸è®°è®°å½•</h3>
                <button class="btn btn-primary" id="addNoteBtn">æ–°å¢æ¸¸è®°</button>
            </div>
            <div id="notesList"></div>
        </div>
    </div>

    <!-- åŠ è½½ä¸­é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ä¼ é€’è®¡åˆ’IDç»™JS
        window.PLAN_ID = parseInt("{{ plan.id }}");
        
        // å½“åœ°å›¾åŠ è½½å¤±è´¥æ—¶çš„å¤„ç†
        window.addEventListener('error', function(event) {
            if (event.target.src && event.target.src.includes('amap')) {
                console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #666; background-color: #f5f5f5; border-radius: 8px;">
                            <h3>ğŸ—ºï¸ åœ°å›¾åŠ è½½å¤±è´¥</h3>
                            <p>æ— æ³•åŠ è½½é«˜å¾·åœ°å›¾API</p>
                            <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIå¯†é’¥é…ç½®</p>
                        </div>
                    `;
                }
            }
        }, true);
        
        // ç™»å½•ç›¸å…³åŠŸèƒ½
        function renderUserBox() {
            fetch('/api/userinfo', {
                credentials: 'include'
            }).then(r=>r.json()).then(data=>{
                const box = document.getElementById('navUserBox');
                if(data.logged_in) {
                    box.innerHTML = `<span style='margin-right:12px;'>ğŸ‘¤ ${data.username}</span><button class='btn btn-small btn-outline' onclick='logoutUser()'>ç™»å‡º</button>`;
                } else {
                    box.innerHTML = `<button class='btn btn-small btn-primary' onclick='showLoginModal()'>ç™»å½•</button>`;
                }
            });
        }
        
        function showLoginModal(message) {
            let modal = document.getElementById('loginModal');
            if(!modal) {
                modal = document.createElement('div');
                modal.id = 'loginModal';
                modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;';
                
                var htmlContent = '<div id="loginBox" style="background:#fff;border-radius:16px;max-width:340px;width:92vw;padding:28px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);">';
                htmlContent += '<h3 style="margin-bottom:18px;">ç”¨æˆ·ç™»å½•</h3>';
                
                if(message) {
                    htmlContent += '<div style="color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;">' + message + '</div>';
                }
                
                htmlContent += '<input id="loginUsername" class="form-input" style="margin-bottom:12px;" placeholder="ç”¨æˆ·å">';
                htmlContent += '<input id="loginPassword" class="form-input" type="password" style="margin-bottom:18px;" placeholder="å¯†ç ">';
                htmlContent += '<div style="text-align:right;">';
                htmlContent += '<button class="btn btn-outline" onclick="closeLoginModal()">å–æ¶ˆ</button>';
                htmlContent += '<button class="btn btn-primary" onclick="loginUser()">ç™»å½•</button>';
                htmlContent += '<button class="btn btn-link" style="margin-left:8px;" onclick="showRegisterBox()">æ³¨å†Œ</button>';
                htmlContent += '</div>';
                htmlContent += '<div id="loginMsg" style="color:#d00;font-size:13px;margin-top:10px;"></div>';
                htmlContent += '</div>';
                
                modal.innerHTML = htmlContent;
                document.body.appendChild(modal);
            } else if (message) {
                // å¦‚æœå¼¹çª—å·²å­˜åœ¨ä½†éœ€è¦æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const loginBox = document.getElementById('loginBox');
                if (loginBox && !document.getElementById('loginErrorMsg')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'loginErrorMsg';
                    errorDiv.style = 'color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;';
                    errorDiv.textContent = message;
                    loginBox.insertBefore(errorDiv, loginBox.firstChild.nextSibling);
                }
            }
            modal.style.display = 'flex';
        }
        
        function showRegisterBox() {
            const box = document.getElementById('loginBox');
            if(box) {
                box.innerHTML = `
                    <h3 style='margin-bottom:18px;'>ç”¨æˆ·æ³¨å†Œ</h3>
                    <input id='regUsername' class='form-input' style='margin-bottom:12px;' placeholder='ç”¨æˆ·å'>
                    <input id='regPassword' class='form-input' type='password' style='margin-bottom:12px;' placeholder='å¯†ç '>
                    <input id='regPassword2' class='form-input' type='password' style='margin-bottom:18px;' placeholder='é‡å¤å¯†ç '>
                    <div style='text-align:right;'>
                        <button class='btn btn-outline' onclick='closeLoginModal()'>å–æ¶ˆ</button>
                        <button class='btn btn-primary' onclick='registerUser()'>æ³¨å†Œ</button>
                        <button class='btn btn-link' style='margin-left:8px;' onclick='showLoginBox()'>è¿”å›ç™»å½•</button>
                    </div>
                    <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
                `;
            }
        }
        
        function showLoginBox() {
            const box = document.getElementById('loginBox');
            if(box) {
                box.innerHTML = `
                    <h3 style='margin-bottom:18px;'>ç”¨æˆ·ç™»å½•</h3>
                    <input id='loginUsername' class='form-input' style='margin-bottom:12px;' placeholder='ç”¨æˆ·å'>
                    <input id='loginPassword' class='form-input' type='password' style='margin-bottom:18px;' placeholder='å¯†ç '>
                    <div style='text-align:right;'>
                        <button class='btn btn-outline' onclick='closeLoginModal()'>å–æ¶ˆ</button>
                        <button class='btn btn-primary' onclick='loginUser()'>ç™»å½•</button>
                        <button class='btn btn-link' style='margin-left:8px;' onclick='showRegisterBox()'>æ³¨å†Œ</button>
                    </div>
                    <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
                `;
            }
        }
        
        function closeLoginModal() {
            let modal = document.getElementById('loginModal');
            if(modal) modal.remove();
        }
        
        function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            fetch('/api/login', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials: 'include',
                body:JSON.stringify({username,password})
            }).then(r=>r.json()).then(d=>{
                if(d.success) { 
                    closeLoginModal(); 
                    // å¦‚æœURLä¸­æœ‰login_requiredå‚æ•°ï¼Œç§»é™¤å®ƒå¹¶é‡æ–°åŠ è½½
                    if (window.location.search.includes('login_required=1')) {
                        const url = new URL(window.location.href);
                        url.searchParams.delete('login_required');
                        window.location.href = url.toString();
                    } else {
                        location.reload(); 
                    }
                }
                else document.getElementById('loginMsg').textContent = d.msg||'ç™»å½•å¤±è´¥';
            });
        }
        
        function logoutUser() {
            fetch('/api/logout', {
                method:'POST',
                credentials: 'include'
            }).then(()=>location.reload());
        }
        
        function registerUser() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const password2 = document.getElementById('regPassword2').value;
            if(!username || !password) { document.getElementById('loginMsg').textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'; return; }
            if(password !== password2) { document.getElementById('loginMsg').textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'; return; }
            fetch('/api/register', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials: 'include',
                body:JSON.stringify({username,password})
            }).then(r=>r.json()).then(d=>{
                if(d.success) {
                    // æ³¨å†ŒæˆåŠŸè‡ªåŠ¨ç™»å½•
                    fetch('/api/login', {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        credentials: 'include',
                        body:JSON.stringify({username,password})
                    }).then(r=>r.json()).then(d2=>{
                        if(d2.success) { 
                            closeLoginModal();
                            // å¦‚æœURLä¸­æœ‰login_requiredå‚æ•°ï¼Œç§»é™¤å®ƒå¹¶é‡æ–°åŠ è½½
                            if (window.location.search.includes('login_required=1')) {
                                const url = new URL(window.location.href);
                                url.searchParams.delete('login_required');
                                window.location.href = url.toString();
                            } else {
                                location.reload(); 
                            }
                        }
                        else document.getElementById('loginMsg').textContent = 'æ³¨å†ŒæˆåŠŸä½†è‡ªåŠ¨ç™»å½•å¤±è´¥';
                    });
                } else {
                    document.getElementById('loginMsg').textContent = d.msg||'æ³¨å†Œå¤±è´¥';
                }
            });
        }
        
        // åˆå§‹åŒ–æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            renderUserBox();
            
            // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœéœ€è¦ç™»å½•åˆ™æ˜¾ç¤ºç™»å½•çª—å£
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('login_required') === '1') {
                showLoginModal('è¯·ç™»å½•åå†è®¿é—®æ­¤é¡µé¢');
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>
    <script src="{{ url_for('static', filename='js/plan.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var btn = document.getElementById('confirmPlanBtn');
        if (btn) {
            btn.addEventListener('click', function() {
                btn.disabled = true;
                btn.textContent = 'æ­£åœ¨ç¡®è®¤...';
                fetch(`/api/plan/${window.PLAN_ID}/confirm`, {method: 'POST'})
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.message || 'ç¡®è®¤å¤±è´¥');
                            btn.disabled = false;
                            btn.textContent = 'ç¡®è®¤è®¡åˆ’';
                        }
                    })
                    .catch(() => {
                        alert('ç½‘ç»œé”™è¯¯ï¼Œç¡®è®¤å¤±è´¥');
                        btn.disabled = false;
                        btn.textContent = 'ç¡®è®¤è®¡åˆ’';
                    });
            });
        }
    });

    // æ¸¸è®°åŠŸèƒ½
    let notesMDE = null;
    function renderNotes() {
        fetch(`/api/plan/${window.PLAN_ID}/notes`).then(r=>r.json()).then(notes=>{
            const list = document.getElementById('notesList');
            if(!notes.length) { list.innerHTML = '<p style="color:#888">æš‚æ— æ¸¸è®°ï¼Œå¿«æ¥è®°å½•ä½ çš„æ—…ç¨‹å§ï¼</p>'; return; }
            list.innerHTML = notes.map((note, idx) => {
                const contentHtml = marked.parse(note.content||'');
                return `
                    <div class='card note-card'>
                        <div style='display:flex;justify-content:space-between;align-items:center;'>
                            <div class='note-title'>${note.title}</div>
                            <div class='note-actions'>
                                <button class='btn btn-small btn-outline' onclick='editNote(${note.id})'><i class="fas fa-pen-to-square"></i> ç¼–è¾‘</button>
                                <button class='btn btn-small btn-danger' onclick='deleteNote(${note.id})'><i class="fas fa-trash-alt"></i> åˆ é™¤</button>
                            </div>
                        </div>
                        <hr style='border:none;border-top:1px solid #f2f2f2;margin:10px 0 12px 0;'>
                        <div style='margin:10px 0; position:relative;'>
                            <div class='note-content-md' id='noteContent${idx}'>${contentHtml}</div>
                            <div class='fade-mask' id='fadeMask${idx}'></div>
                        </div>
                        <div class='show-toggle-btn'><button id='toggleBtn${idx}' onclick='toggleNoteContent(${idx})'>å±•å¼€</button></div>
                        <div style='display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;'>
                            ${(note.media||[]).map(url=>url.match(/(jpg|jpeg|png|gif)$/i)?`<img src='${url}' style='max-width:120px;border-radius:8px;'>`:`<video src='${url}' controls style='max-width:160px;border-radius:8px;'></video>`).join('')}
                        </div>
                        <div class='note-time'>${note.created_at.replace('T',' ').slice(0,16)}</div>
                    </div>
                `;
            }).join('');
        });
    }
    function showNoteModal(note) {
        let modal = document.getElementById('noteModal');
        if(!modal) {
            modal = document.createElement('div');
            modal.id = 'noteModal';
            modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;overflow:auto;';
            modal.innerHTML = `
            <div style='background:#fff;border-radius:16px;max-width:520px;width:96vw;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);max-height:96vh;overflow:auto;box-sizing:border-box;'>
                <h3 style='margin-bottom:12px;'>${note&&note.id?'ç¼–è¾‘':'æ–°å¢'}æ¸¸è®°</h3>
                <input id='noteTitle' class='form-input' style='margin-bottom:12px;' placeholder='æ¸¸è®°æ ‡é¢˜' value='${note?note.title:''}'>
                <textarea id='noteEditor' style='min-height:120px;max-height:40vh;background:#fafbfc;margin-bottom:12px;'>${note?note.content||'':''}</textarea>
                <div style='margin-bottom:12px;'>
                    <input type='file' id='noteFileInput' accept='image/*,video/*' style='display:none;'>
                    <button class='btn btn-outline' id='uploadFileBtn' type='button'>ä¸Šä¼ å›¾ç‰‡/è§†é¢‘</button>
                    <span id='uploadStatus' style='color:#888;font-size:12px;margin-left:8px;'></span>
                </div>
                <div style='margin:12px 0 0 0;text-align:right;'>
                    <button class='btn btn-outline' onclick='closeNoteModal()'>å–æ¶ˆ</button>
                    <button class='btn btn-primary' id='saveNoteBtn'>ä¿å­˜</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        }
        modal.style.display = 'flex';
        setTimeout(()=>{
            notesMDE = new EasyMDE({
                element: document.getElementById('noteEditor'),
                autoDownloadFontAwesome: false,
                spellChecker: false,
                status: false,
                minHeight: '180px',
                toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "link", "image", "table", "preview", "side-by-side", "fullscreen", "guide"]
            });
            
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè®¾ç½®ç¼–è¾‘å™¨å†…å®¹
            if(note && note.content) {
                notesMDE.value(note.content);
            }
            
            // ä¸Šä¼ æŒ‰é’®é€»è¾‘
            document.getElementById('uploadFileBtn').onclick = function() {
                document.getElementById('noteFileInput').click();
            };
            document.getElementById('noteFileInput').onchange = function(e) {
                const file = e.target.files[0];
                if(!file) return;
                const status = document.getElementById('uploadStatus');
                status.textContent = 'ä¸Šä¼ ä¸­...';
                const formData = new FormData();
                formData.append('file', file);
                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                }).then(r=>r.json()).then(res=>{
                    if(res.success && res.url) {
                        status.textContent = 'ä¸Šä¼ æˆåŠŸ';
                        // åˆ¤æ–­å›¾ç‰‡/è§†é¢‘ï¼Œæ’å…¥markdown
                        let insertText = '';
                        if(file.type.startsWith('image/')) {
                            insertText = `![](${res.url})`;
                        } else if(file.type.startsWith('video/')) {
                            insertText = `\n[è§†é¢‘](${res.url})\n`;
                        }
                        if(insertText) {
                            const cm = notesMDE.codemirror;
                            const doc = cm.getDoc();
                            doc.replaceSelection(insertText);
                        }
                    } else {
                        status.textContent = 'ä¸Šä¼ å¤±è´¥';
                    }
                }).catch(()=>{
                    status.textContent = 'ä¸Šä¼ å¤±è´¥';
                });
            };
        }, 10);
        document.getElementById('saveNoteBtn').onclick = function() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = notesMDE.value();
            if(!title) { alert('è¯·è¾“å…¥æ ‡é¢˜'); return; }
            const method = note&&note.id?'PUT':'POST';
            const url = note&&note.id?`/api/note/${note.id}`:`/api/plan/${window.PLAN_ID}/notes`;
            fetch(url, {
                method,
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({title,content})
            }).then(r=>r.json()).then(d=>{
                if(d.success) { closeNoteModal(); renderNotes(); }
                else alert('ä¿å­˜å¤±è´¥');
            });
        };
    }
    function closeNoteModal() {
        let modal = document.getElementById('noteModal');
        if(modal) { 
            modal.style.display='none'; 
            modal.remove();
            // æ¸…ç†ç¼–è¾‘å™¨å®ä¾‹
            if(notesMDE) {
                notesMDE.toTextArea();
                notesMDE = null;
            }
        }
    }
    function editNote(id) {
        fetch(`/api/note/${id}`).then(r=>r.json()).then(note=>{
            if(note.id) {
            showNoteModal(note);
            } else {
                alert('è·å–æ¸¸è®°å†…å®¹å¤±è´¥');
            }
        }).catch(error => {
            console.error('è·å–æ¸¸è®°å¤±è´¥:', error);
            alert('è·å–æ¸¸è®°å†…å®¹å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    function deleteNote(id) {
        if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ¸¸è®°å—ï¼Ÿ')) return;
        fetch(`/api/note/${id}`,{method:'DELETE'}).then(r=>r.json()).then(d=>{if(d.success)renderNotes();else alert('åˆ é™¤å¤±è´¥');});
    }
    document.getElementById('addNoteBtn').onclick = ()=>showNoteModal();
    renderNotes();

    // æ·»åŠ JSæŠ˜å /å±•å¼€é€»è¾‘
    window.toggleNoteContent = function(idx) {
        const content = document.getElementById('noteContent'+idx);
        const mask = document.getElementById('fadeMask'+idx);
        const btn = document.getElementById('toggleBtn'+idx);
        if(content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            mask.style.display = '';
            btn.textContent = 'å±•å¼€';
        } else {
            content.classList.add('expanded');
            mask.style.display = 'none';
            btn.textContent = 'æ”¶èµ·';
        }
    }

    // æ¸²æŸ“åè‡ªåŠ¨åˆ¤æ–­å†…å®¹é«˜åº¦ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºé®ç½©å’ŒæŒ‰é’®
    setTimeout(()=>{
        document.querySelectorAll('.note-content-md').forEach((el, idx)=>{
            const mask = document.getElementById('fadeMask'+idx);
            const btn = document.getElementById('toggleBtn'+idx);
            if(el.scrollHeight <= 210) {
                if(mask) mask.style.display = 'none';
                if(btn) btn.style.display = 'none';
            } else {
                if(mask) mask.style.display = '';
                if(btn) btn.style.display = '';
            }
        });
    }, 100);

    // åˆ†äº«è®¡åˆ’åŠŸèƒ½
    function showSharePlanModal() {
        const modal = document.createElement('div');
        modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;overflow:auto;';
        modal.innerHTML = `
        <div style='background:var(--apple-system-background, #fff);border-radius:16px;max-width:520px;width:96vw;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);max-height:96vh;overflow:auto;box-sizing:border-box;'>
            <h3 style='margin-bottom:16px;color:var(--apple-label, #000);'>åˆ†äº«æ—…è¡Œè®¡åˆ’</h3>
            <p style='color:var(--apple-secondary-label, #666);margin-bottom:20px;'>å°†æ‚¨çš„æ—…è¡Œè®¡åˆ’åˆ†äº«åˆ°åŠ¨æ€ï¼Œè®©å¥½å‹äº†è§£æ‚¨çš„ç²¾å½©è¡Œç¨‹ã€‚</p>
            <div style="margin-bottom:16px;">
                <textarea id="shareText" class="form-input" placeholder="æ·»åŠ åˆ†äº«æ–‡å­—..." style="width:100%;min-height:80px;margin-bottom:8px;">#æ—…è¡Œè®¡åˆ’# æˆ‘çš„ç²¾å½©è¡Œç¨‹å®‰æ’ï¼Œä¸€èµ·æ¥çœ‹çœ‹å§ï¼âœˆï¸</textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;color:var(--apple-label, #000);">å¯è§æ€§ï¼š</label>
                <select id="shareVisibility" class="form-input" style="width:100%;">
                    <option value="public">æ‰€æœ‰äººå¯è§</option>
                    <option value="friends">ä»…å¥½å‹å¯è§</option>
                    <option value="private">ä»…è‡ªå·±å¯è§</option>
                </select>
            </div>
            <div style="margin-bottom:20px;padding:12px;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;margin-bottom:8px;">
                    <input type="checkbox" id="includeShareLink" checked style="margin-right:8px;">
                    <label for="includeShareLink" style="color:var(--apple-label, #000);font-size:14px;">åŒ…å«åˆ†äº«é“¾æ¥</label>
                </div>
                <div style="font-size:12px;color:var(--apple-secondary-label, #666);">
                    é€‰ä¸­åå°†ç”Ÿæˆå¯å…¬å¼€è®¿é—®çš„è®¡åˆ’é“¾æ¥ï¼Œä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡é“¾æ¥æŸ¥çœ‹æ‚¨çš„è®¡åˆ’è¯¦æƒ…
                </div>
            </div>
            <div style='text-align:right;'>
                <button class='btn btn-outline' onclick='closePlanShareModal()' style="margin-right:8px;">å–æ¶ˆ</button>
                <button class='btn btn-primary' onclick='confirmSharePlan()'>åˆ†äº«åˆ°åŠ¨æ€</button>
            </div>
        </div>`;
        
        modal.onclick = function(e) {
            if (e.target === modal) closePlanShareModal();
        };
        
        document.body.appendChild(modal);
        modal.id = 'planShareModal';
    }

    function confirmSharePlan() {
        const shareText = document.getElementById('shareText').value.trim();
        const visibility = document.getElementById('shareVisibility').value;
        const includeLink = document.getElementById('includeShareLink').checked;
        
        if (!shareText) {
            alert('è¯·è¾“å…¥åˆ†äº«å†…å®¹');
            return;
        }
        
        // æ˜¾ç¤ºåˆ†äº«æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        const shareBtn = document.querySelector('#planShareModal .btn-primary');
        const originalText = shareBtn.textContent;
        shareBtn.disabled = true;
        shareBtn.textContent = 'æ­£åœ¨åˆ†äº«...';
        
        // æ„å»ºåˆ†äº«æµç¨‹
        let sharePromise;
        
        if (includeLink) {
            // å…ˆç”Ÿæˆåˆ†äº«é“¾æ¥ï¼Œå†åˆ†äº«
            sharePromise = fetch(`/api/plan/${window.PLAN_ID}/share-link`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(linkData => {
                if (linkData.success) {
                    // è·å–å½“å‰è®¡åˆ’ä¿¡æ¯å¹¶åŒ…å«åˆ†äº«é“¾æ¥
                    return fetch(`/api/plan/${window.PLAN_ID}`, {
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(planData => {
                        const planSummary = `
ğŸ“… å‡ºè¡Œæ—¶é—´ï¼š${planData.start_date} è‡³ ${planData.end_date} (${planData.total_days}å¤©)
ğŸ¯ æ—…è¡Œä¸»é¢˜ï¼š${planData.travel_theme}
ğŸš— å‡ºè¡Œæ–¹å¼ï¼š${planData.transport_mode}
ğŸ’° é¢„ç®—èŒƒå›´ï¼šÂ¥${planData.budget_min} - Â¥${planData.budget_max}

ğŸ”— æŸ¥çœ‹å®Œæ•´è®¡åˆ’ï¼š${linkData.share_url}`;
                        
                        const momentContent = `${shareText}\n\n---\n**è®¡åˆ’è¯¦æƒ…**ï¼š\n${planSummary}`;
                        
                        return fetch('/api/moments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                content: momentContent,
                                media: [],
                                visibility: visibility
                            })
                        });
                    });
                } else {
                    throw new Error(linkData.msg || 'ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥');
                }
            });
        } else {
            // ä¸åŒ…å«é“¾æ¥ï¼Œåªåˆ†äº«è®¡åˆ’æ‘˜è¦
            sharePromise = fetch(`/api/plan/${window.PLAN_ID}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(planData => {
                const planSummary = `
ğŸ“… å‡ºè¡Œæ—¶é—´ï¼š${planData.start_date} è‡³ ${planData.end_date} (${planData.total_days}å¤©)
ğŸ¯ æ—…è¡Œä¸»é¢˜ï¼š${planData.travel_theme}
ğŸš— å‡ºè¡Œæ–¹å¼ï¼š${planData.transport_mode}
ğŸ’° é¢„ç®—èŒƒå›´ï¼šÂ¥${planData.budget_min} - Â¥${planData.budget_max}`;
                
                const momentContent = `${shareText}\n\n---\n**è®¡åˆ’è¯¦æƒ…**ï¼š\n${planSummary}`;
                
                return fetch('/api/moments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        content: momentContent,
                        media: [],
                        visibility: visibility
                    })
                });
            });
        }
        
        sharePromise
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    closePlanShareModal();
                    if (includeLink) {
                        showToast('è®¡åˆ’å·²æˆåŠŸåˆ†äº«åˆ°åŠ¨æ€ï¼ŒåŒ…å«å…¬å¼€è®¿é—®é“¾æ¥ï¼', 'success');
                    } else {
                        showToast('è®¡åˆ’å·²æˆåŠŸåˆ†äº«åˆ°åŠ¨æ€ï¼', 'success');
                    }
                } else {
                    alert('åˆ†äº«å¤±è´¥: ' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('åˆ†äº«å¤±è´¥:', error);
                alert('åˆ†äº«å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                shareBtn.disabled = false;
                shareBtn.textContent = originalText;
            });
    }

    function closePlanShareModal() {
        const modal = document.getElementById('planShareModal');
        if (modal) modal.remove();
    }

    // æ‰“å°è®¡åˆ’åŠŸèƒ½
    function printPlan() {
        // è·å–è®¡åˆ’æ•°æ®
        fetch(`/api/plan/${window.PLAN_ID}`)
            .then(response => response.json())
            .then(planData => {
                const printWindow = window.open('', '_blank');
                const printContent = generatePrintContent(planData);
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // ç­‰å¾…å†…å®¹åŠ è½½å®Œæˆåæ‰“å°
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                };
            })
            .catch(error => {
                console.error('è·å–è®¡åˆ’æ•°æ®å¤±è´¥:', error);
                alert('è·å–è®¡åˆ’æ•°æ®å¤±è´¥ï¼Œæ— æ³•æ‰“å°');
            });
    }

    function generatePrintContent(planData) {
        // æ ¼å¼åŒ–è¡Œç¨‹å†…å®¹
        let itineraryHtml = '';
        if (planData.itineraries && planData.itineraries.length > 0) {
            itineraryHtml = planData.itineraries.map(day => {
                let itemsHtml = '';
                if (day.items && day.items.length > 0) {
                    itemsHtml = day.items.map(item => `
                        <div style="margin-bottom: 12px; padding: 8px; background: #f9f9f9; border-radius: 6px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                ${item.start_time} - ${item.title}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 2px;">
                                ğŸ“ ${item.location || 'æœªè®¾ç½®åœ°ç‚¹'}
                            </div>
                            ${item.description ? `<div style="color: #666; font-size: 14px;">${item.description}</div>` : ''}
                            ${item.estimated_cost > 0 ? `<div style="color: #007AFF; font-size: 14px; font-weight: 500;">ğŸ’° é¢„ä¼°è´¹ç”¨: Â¥${item.estimated_cost}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    itemsHtml = '<div style="color: #999; font-style: italic;">æš‚æ— å…·ä½“å®‰æ’</div>';
                }

                return `
                    <div style="margin-bottom: 24px; page-break-inside: avoid;">
                        <h3 style="color: #007AFF; border-bottom: 2px solid #007AFF; padding-bottom: 6px; margin-bottom: 12px;">
                            ç¬¬${day.day_number}å¤© - ${day.date} ${day.theme ? `(${day.theme})` : ''}
                        </h3>
                        ${itemsHtml}
                    </div>
                `;
            }).join('');
        } else {
            itineraryHtml = '<div style="color: #999; font-style: italic; text-align: center; padding: 20px;">æš‚æ— è¡Œç¨‹å®‰æ’</div>';
        }

        return `
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <title>æ—…è¡Œè®¡åˆ’ - ${planData.title}</title>
            <style>
                @media print {
                    @page { margin: 1.5cm; }
                    body { -webkit-print-color-adjust: exact; }
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }
                .header {
                    text-align: center;
                    border-bottom: 3px solid #007AFF;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .title {
                    font-size: 28px;
                    font-weight: 700;
                    color: #007AFF;
                    margin-bottom: 10px;
                }
                .info-grid {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 20px;
                    margin-bottom: 30px;
                    justify-content: center;
                }
                .info-item {
                    background: #f8f9fa;
                    padding: 12px 16px;
                    border-radius: 8px;
                    min-width: 150px;
                    text-align: center;
                }
                .info-label {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 4px;
                }
                .info-value {
                    font-size: 16px;
                    font-weight: 600;
                    color: #333;
                }
                .section-title {
                    font-size: 20px;
                    font-weight: 600;
                    color: #333;
                    margin: 30px 0 15px 0;
                    border-left: 4px solid #007AFF;
                    padding-left: 12px;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    text-align: center;
                    color: #666;
                    font-size: 14px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="title">${planData.title}</div>
                <div style="color: #666; font-size: 16px;">æ—…è¡Œè®¡åˆ’è¯¦æƒ…</div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">å‡ºè¡Œæ—¥æœŸ</div>
                    <div class="info-value">${planData.start_date} è‡³ ${planData.end_date}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ€»å¤©æ•°</div>
                    <div class="info-value">${planData.total_days}å¤©</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ—…è¡Œä¸»é¢˜</div>
                    <div class="info-value">${planData.travel_theme}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å‡ºè¡Œæ–¹å¼</div>
                    <div class="info-value">${planData.transport_mode}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">é¢„ç®—èŒƒå›´</div>
                    <div class="info-value">Â¥${planData.budget_min} - Â¥${planData.budget_max}</div>
                </div>
            </div>

            <div class="section-title">ğŸ“… è¯¦ç»†è¡Œç¨‹å®‰æ’</div>
            ${itineraryHtml}

            <div class="footer">
                <div>æ­¤è®¡åˆ’ç”± Travel Agent æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹ç”Ÿæˆ</div>
                <div>æ‰“å°æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</div>
            </div>
        </body>
        </html>
        `;
    }

    // é€šç”¨æç¤ºå‡½æ•°
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s;
        `;
        
        if (type === 'success') {
            toast.style.background = '#34C759';
            toast.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                ${message}
            `;
        } else if (type === 'error') {
            toast.style.background = '#FF3B30';
            toast.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                ${message}
            `;
        }
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    </script>
</body>
</html> 
