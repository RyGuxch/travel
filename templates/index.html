<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Agent - æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">ğŸŒ Travel Agent</a>
            <div class="nav-links">
                <a href="/">é¦–é¡µ</a>
                <a href="/plans">æˆ‘çš„è®¡åˆ’</a>
                <a href="/notes">å…¨éƒ¨æ¸¸è®°</a>
                <a href="/expenses">å¼€é”€</a>
                <a href="/moments">åŠ¨æ€</a>
                <a href="/friends">å¥½å‹</a>
                <a href="/reports">æŠ¥å‘Š</a>
                <a href="/about">å…³äº</a>
            </div>
            <div class="nav-user" id="navUserBox"></div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-container">
        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div class="card">
            <h1 class="title-large">æ™ºèƒ½æ—…è¡Œè§„åˆ’åŠ©æ‰‹</h1>
            <p class="subtitle">è®©AIä¸ºæ‚¨å®šåˆ¶ä¸“å±çš„æ—…è¡Œæ–¹æ¡ˆï¼Œè½»æ¾è§„åˆ’ç¾å¥½æ—…ç¨‹</p>
        </div>

        <div class="grid-2">
            <!-- è®¡åˆ’ç”Ÿæˆè¡¨å• -->
            <div class="card">
                <h2 class="title-medium">åˆ›å»ºæ–°çš„æ—…è¡Œè®¡åˆ’</h2>
                
                <form id="planForm">
                    <div class="form-group">
                        <label class="form-label">ç›®çš„åœ°</label>
                        <input type="text" id="destinations" class="form-input" 
                               placeholder="è¯·è¾“å…¥ç›®çš„åœ°ï¼Œå¤šä¸ªåœ°ç‚¹ç”¨é€—å·åˆ†éš”" required>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">è¡Œç¨‹å¤©æ•°</label>
                            <input type="number" id="days" class="form-input" 
                                   min="1" max="30" value="3" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ—…è¡Œä¸»é¢˜</label>
                            <select id="theme" class="form-input" onchange="document.getElementById('themeCustomBox').style.display = this.value === 'è‡ªå®šä¹‰' ? 'block' : 'none'">
                                <option value="è§‚å…‰">è§‚å…‰æ—…æ¸¸</option>
                                <option value="æ–‡åŒ–">æ–‡åŒ–ä½“éªŒ</option>
                                <option value="è‡ªç„¶">è‡ªç„¶é£å…‰</option>
                                <option value="ç¾é£Ÿ">ç¾é£Ÿä¹‹æ—…</option>
                                <option value="ä¼‘é—²">ä¼‘é—²åº¦å‡</option>
                                <option value="å†’é™©">å†’é™©æ¢ç´¢</option>
                                <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                            </select>
                            <div id="themeCustomBox" style="display:none;margin-top:8px;">
                                <input type="text" id="themeCustom" class="form-input" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ä¸»é¢˜">
                            </div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">é¢„ç®—ä¸‹é™ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="budgetMin" class="form-input" 
                                   min="0" value="1000">
                        </div>

                        <div class="form-group">
                            <label class="form-label">é¢„ç®—ä¸Šé™ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="budgetMax" class="form-input" 
                                   min="0" value="5000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‡ºè¡Œæ–¹å¼</label>
                        <select id="transport" class="form-input" onchange="document.getElementById('transportCustomBox').style.display = this.value === 'è‡ªå®šä¹‰' ? 'block' : 'none'">
                            <option value="é«˜é“">é«˜é“</option>
                            <option value="é£æœº">é£æœº</option>
                            <option value="è‡ªé©¾">è‡ªé©¾</option>
                            <option value="æ±½è½¦">é•¿é€”æ±½è½¦</option>
                            <option value="æ­¥è¡Œ">æ­¥è¡Œ</option>
                            <option value="éª‘è¡Œ">éª‘è¡Œ</option>
                            <option value="å…¬äº¤">å…¬äº¤</option>
                            <option value="æ··åˆ">å¤šç§æ–¹å¼</option>
                            <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                        </select>
                        <div id="transportCustomBox" style="display:none;margin-top:8px;">
                            <input type="text" id="transportCustom" class="form-input" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰å‡ºè¡Œæ–¹å¼">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‡ºè¡Œæ—¥æœŸ</label>
                        <input type="date" id="startDate" class="form-input" required>
                    </div>

                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        <span id="btnText">ğŸ¤– AIç”Ÿæˆæ—…è¡Œæ–¹æ¡ˆ</span>
                        <span id="btnLoading" class="hidden">
                            <div class="spinner"></div>
                            æ­£åœ¨ç”Ÿæˆ...
                        </span>
                    </button>
                </form>
            </div>

            <!-- è®¡åˆ’åˆ—è¡¨ -->
            <div class="card">
                <h2 class="title-medium">æˆ‘çš„æ—…è¡Œè®¡åˆ’</h2>
                <div id="plansList">
                    <p class="subtitle">æ­£åœ¨åŠ è½½...</p>
                </div>
            </div>
        </div>

        <!-- ç”Ÿæˆç»“æœå±•ç¤º -->
        <div id="resultSection" class="card hidden">
            <h2 class="title-medium">ç”Ÿæˆçš„æ—…è¡Œæ–¹æ¡ˆ</h2>
            <div id="planResult"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    // æäº¤æ—¶ä¼˜å…ˆå–è‡ªå®šä¹‰å†…å®¹
    document.getElementById('planForm').addEventListener('submit', function(e) {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        fetch('/api/userinfo', {
            credentials: 'include'
        }).then(r=>r.json()).then(data=>{
            if(!data.logged_in) {
                e.preventDefault();
                showLoginModal('è¯·å…ˆç™»å½•åå†ç”Ÿæˆæ—…è¡Œè®¡åˆ’');
                return false;
            }
            
            const themeSel = document.getElementById('theme');
            const themeCustom = document.getElementById('themeCustom').value.trim();
            if(themeSel.value === 'è‡ªå®šä¹‰' && !themeCustom) {
                alert('è¯·è¾“å…¥è‡ªå®šä¹‰æ—…è¡Œä¸»é¢˜');
                e.preventDefault();
                return false;
            }
            const transportSel = document.getElementById('transport');
            const transportCustom = document.getElementById('transportCustom').value.trim();
            if(transportSel.value === 'è‡ªå®šä¹‰' && !transportCustom) {
                alert('è¯·è¾“å…¥è‡ªå®šä¹‰å‡ºè¡Œæ–¹å¼');
                e.preventDefault();
                return false;
            }
        });
        
        // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤ï¼Œç­‰å¾…å¼‚æ­¥æ£€æŸ¥å®Œæˆ
        e.preventDefault();
        return false;
    });

    document.addEventListener('DOMContentLoaded', function() {
        var dateInput = document.getElementById('startDate');
        if (dateInput && !dateInput.value) {
            var today = new Date();
            var yyyy = today.getFullYear();
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = yyyy + '-' + mm + '-' + dd;
        }
        
        // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœéœ€è¦ç™»å½•åˆ™æ˜¾ç¤ºç™»å½•çª—å£
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('login_required') === '1') {
            showLoginModal('è¯·ç™»å½•åå†è®¿é—®æ­¤é¡µé¢');
        }
    });

    function renderUserBox() {
        fetch('/api/userinfo', {
            credentials: 'include'
        }).then(r=>r.json()).then(data=>{
            const box = document.getElementById('navUserBox');
            if(data.logged_in) {
                box.innerHTML = `<span style='margin-right:12px;'>ğŸ‘¤ ${data.username}</span><button class='btn btn-small btn-outline' onclick='logoutUser()'>ç™»å‡º</button>`;
            } else {
                box.innerHTML = `<button class='btn btn-small btn-primary' onclick='showLoginModal()'>ç™»å½•</button>`;
            }
        });
    }
    
    function showLoginModal(message) {
        let modal = document.getElementById('loginModal');
        if(!modal) {
            modal = document.createElement('div');
            modal.id = 'loginModal';
            modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
            <div id='loginBox' style='background:#fff;border-radius:16px;max-width:340px;width:92vw;padding:28px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);'>
                <h3 style='margin-bottom:18px;'>ç”¨æˆ·ç™»å½•</h3>
                ${message ? `<div style="color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;">${message}</div>` : ''}
                <input id='loginUsername' class='form-input' style='margin-bottom:12px;' placeholder='ç”¨æˆ·å'>
                <input id='loginPassword' class='form-input' type='password' style='margin-bottom:18px;' placeholder='å¯†ç '>
                <div style='text-align:right;'>
                    <button class='btn btn-outline' onclick='closeLoginModal()'>å–æ¶ˆ</button>
                    <button class='btn btn-primary' onclick='loginUser()'>ç™»å½•</button>
                    <button class='btn btn-link' style='margin-left:8px;' onclick='showRegisterBox()'>æ³¨å†Œ</button>
                </div>
                <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
            </div>`;
            document.body.appendChild(modal);
        } else if (message) {
            // å¦‚æœå¼¹çª—å·²å­˜åœ¨ä½†éœ€è¦æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const loginBox = document.getElementById('loginBox');
            if (loginBox && !document.getElementById('loginErrorMsg')) {
                const errorDiv = document.createElement('div');
                errorDiv.id = 'loginErrorMsg';
                errorDiv.style = 'color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;';
                errorDiv.textContent = message;
                loginBox.insertBefore(errorDiv, loginBox.firstChild.nextSibling);
            }
        }
        modal.style.display = 'flex';
    }
    function showRegisterBox() {
        const box = document.getElementById('loginBox');
        if(box) {
            box.innerHTML = `
                <h3 style='margin-bottom:18px;'>ç”¨æˆ·æ³¨å†Œ</h3>
                <input id='regUsername' class='form-input' style='margin-bottom:12px;' placeholder='ç”¨æˆ·å'>
                <input id='regPassword' class='form-input' type='password' style='margin-bottom:12px;' placeholder='å¯†ç '>
                <input id='regPassword2' class='form-input' type='password' style='margin-bottom:18px;' placeholder='é‡å¤å¯†ç '>
                <div style='text-align:right;'>
                    <button class='btn btn-outline' onclick='closeLoginModal()'>å–æ¶ˆ</button>
                    <button class='btn btn-primary' onclick='registerUser()'>æ³¨å†Œ</button>
                    <button class='btn btn-link' style='margin-left:8px;' onclick='showLoginBox()'>è¿”å›ç™»å½•</button>
                </div>
                <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
            `;
        }
    }
    function showLoginBox() {
        const box = document.getElementById('loginBox');
        if(box) {
            box.innerHTML = `
                <h3 style='margin-bottom:18px;'>ç”¨æˆ·ç™»å½•</h3>
                <input id='loginUsername' class='form-input' style='margin-bottom:12px;' placeholder='ç”¨æˆ·å'>
                <input id='loginPassword' class='form-input' type='password' style='margin-bottom:18px;' placeholder='å¯†ç '>
                <div style='text-align:right;'>
                    <button class='btn btn-outline' onclick='closeLoginModal()'>å–æ¶ˆ</button>
                    <button class='btn btn-primary' onclick='loginUser()'>ç™»å½•</button>
                    <button class='btn btn-link' style='margin-left:8px;' onclick='showRegisterBox()'>æ³¨å†Œ</button>
                </div>
                <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
            `;
        }
    }
    function closeLoginModal() {
        let modal = document.getElementById('loginModal');
        if(modal) modal.remove();
    }
    function loginUser() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        fetch('/api/login', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials: 'include',
            body:JSON.stringify({username,password})
        }).then(r=>r.json()).then(d=>{
            if(d.success) { 
                closeLoginModal(); 
                // å¦‚æœURLä¸­æœ‰login_requiredå‚æ•°ï¼Œç§»é™¤å®ƒå¹¶é‡æ–°åŠ è½½
                if (window.location.search.includes('login_required=1')) {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('login_required');
                    window.location.href = url.toString();
                } else {
                    location.reload(); 
                }
            }
            else document.getElementById('loginMsg').textContent = d.msg||'ç™»å½•å¤±è´¥';
        });
    }
    function logoutUser() {
        fetch('/api/logout', {
            method:'POST',
            credentials: 'include'
        }).then(()=>location.reload());
    }
    function registerUser() {
        const username = document.getElementById('regUsername').value.trim();
        const password = document.getElementById('regPassword').value;
        const password2 = document.getElementById('regPassword2').value;
        if(!username || !password) { document.getElementById('loginMsg').textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'; return; }
        if(password !== password2) { document.getElementById('loginMsg').textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'; return; }
        fetch('/api/register', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials: 'include',
            body:JSON.stringify({username,password})
        }).then(r=>r.json()).then(d=>{
            if(d.success) {
                // æ³¨å†ŒæˆåŠŸè‡ªåŠ¨ç™»å½•
                fetch('/api/login', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials: 'include',
                    body:JSON.stringify({username,password})
                }).then(r=>r.json()).then(d2=>{
                    if(d2.success) { 
                        closeLoginModal(); 
                        // å¦‚æœURLä¸­æœ‰login_requiredå‚æ•°ï¼Œç§»é™¤å®ƒå¹¶é‡æ–°åŠ è½½
                        if (window.location.search.includes('login_required=1')) {
                            const url = new URL(window.location.href);
                            url.searchParams.delete('login_required');
                            window.location.href = url.toString();
                        } else {
                            location.reload(); 
                        }
                    }
                    else document.getElementById('loginMsg').textContent = 'æ³¨å†ŒæˆåŠŸä½†è‡ªåŠ¨ç™»å½•å¤±è´¥';
                });
            } else {
                document.getElementById('loginMsg').textContent = d.msg||'æ³¨å†Œå¤±è´¥';
            }
        });
    }
    document.addEventListener('DOMContentLoaded', renderUserBox);
    </script>
</body>
</html> 