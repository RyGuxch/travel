<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹ç®¡ç† - Travel Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .friend-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .friend-info {
            display: flex;
            align-items: center;
        }
        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4285f4;
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        .search-result {
            margin-top: 16px;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 16px;
        }
        .tab {
            padding: 12px 16px;
            cursor: pointer;
        }
        .tab.active {
            border-bottom: 2px solid #4285f4;
            color: #4285f4;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .friend-request {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .request-actions {
            display: flex;
            gap: 8px;
        }
        .empty-state {
            text-align: center;
            padding: 24px;
            color: #666;
        }
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        .unread-badge {
            background-color: #FF3B30;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">ğŸŒ Travel Agent</a>
            <div class="nav-links">
                <a href="/">é¦–é¡µ</a>
                <a href="/plans">æˆ‘çš„è®¡åˆ’</a>
                <a href="/notes">æ¸¸è®°</a>
                <a href="/expenses">å¼€é”€</a>
                <a href="/moments">åŠ¨æ€</a>
                <a href="/friends" class="active">å¥½å‹</a>
                <a href="/reports">æŠ¥å‘Š</a>
                <a href="/about">å…³äº</a>
            </div>
            <div class="nav-user" id="navUserBox"></div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-container">
        <div class="card">
            <h1 class="title-large">å¥½å‹ç®¡ç†</h1>
            <p class="subtitle">ç®¡ç†æ‚¨çš„å¥½å‹ï¼ŒæŸ¥çœ‹å’Œå¤„ç†å¥½å‹è¯·æ±‚</p>
            
            <div class="tabs">
                <div class="tab active" data-tab="friends">æˆ‘çš„å¥½å‹</div>
                <div class="tab" data-tab="requests">å¥½å‹è¯·æ±‚ <span id="requestCount" class="badge"></span></div>
                <div class="tab" data-tab="search">æŸ¥æ‰¾ç”¨æˆ·</div>
            </div>
            
            <!-- å¥½å‹åˆ—è¡¨ -->
            <div class="tab-content active" id="friends-tab">
                <div id="friendsList">
                    <p class="subtitle">æ­£åœ¨åŠ è½½å¥½å‹åˆ—è¡¨...</p>
                </div>
            </div>
            
            <!-- å¥½å‹è¯·æ±‚ -->
            <div class="tab-content" id="requests-tab">
                <div id="requestsList">
                    <p class="subtitle">æ­£åœ¨åŠ è½½å¥½å‹è¯·æ±‚...</p>
                </div>
            </div>
            
            <!-- æŸ¥æ‰¾ç”¨æˆ· -->
            <div class="tab-content" id="search-tab">
                <div class="form-group">
                    <label class="form-label">æœç´¢ç”¨æˆ·</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="searchKeyword" class="form-input" 
                               placeholder="è¾“å…¥ç”¨æˆ·åæœç´¢" required>
                        <button type="button" class="btn btn-primary" id="searchBtn">æœç´¢</button>
                    </div>
                </div>
                
                <div id="searchResults" class="search-result">
                    <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯æ¡†
    function renderUserBox() {
        fetch('/api/userinfo', {
            credentials: 'include'
        }).then(r=>r.json()).then(data=>{
            const box = document.getElementById('navUserBox');
            if(data.logged_in) {
                box.innerHTML = `<a href="/profile" style="color: var(--text-primary); text-decoration: none; margin-right: 12px; display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 8px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'" onmouseout="this.style.backgroundColor='transparent'">ğŸ‘¤ ${data.username}</a><button class='btn btn-small btn-outline' onclick='logoutUser()'>ç™»å‡º</button>`;
            } else {
                box.innerHTML = `<button class='btn btn-small btn-primary' onclick='showLoginModal()'>ç™»å½•</button>`;
            }
        });
    }
    
    // ç™»å‡ºç”¨æˆ·
    function logoutUser() {
        fetch('/api/logout', {
            method:'POST',
            credentials: 'include'
        }).then(()=>location.reload());
    }
    
    // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
    function showLoginModal(message) {
        let modal = document.getElementById('loginModal');
        if(!modal) {
            modal = document.createElement('div');
            modal.id = 'loginModal';
            modal.style = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;';
            
            var htmlContent = '<div id="loginBox" style="background:#fff;border-radius:16px;max-width:340px;width:92vw;padding:28px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.12);">';
            htmlContent += '<h3 style="margin-bottom:18px;">ç”¨æˆ·ç™»å½•</h3>';
            
            if(message) {
                htmlContent += '<div style="color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;">' + message + '</div>';
            }
            
            htmlContent += '<input id="loginUsername" class="form-input" style="margin-bottom:12px;" placeholder="ç”¨æˆ·å">';
            htmlContent += '<input id="loginPassword" class="form-input" type="password" style="margin-bottom:18px;" placeholder="å¯†ç ">';
            htmlContent += '<div style="text-align:right;">';
            htmlContent += '<button class="btn btn-outline" onclick="closeLoginModal()">å–æ¶ˆ</button>';
            htmlContent += '<button class="btn btn-primary" onclick="loginUser()">ç™»å½•</button>';
            htmlContent += '<button class="btn btn-link" style="margin-left:8px;" onclick="showRegisterBox()">æ³¨å†Œ</button>';
            htmlContent += '</div>';
            htmlContent += '<div id="loginMsg" style="color:#d00;font-size:13px;margin-top:10px;"></div>';
            htmlContent += '</div>';
            
            modal.innerHTML = htmlContent;
            document.body.appendChild(modal);
        } else if (message) {
            // å¦‚æœå¼¹çª—å·²å­˜åœ¨ä½†éœ€è¦æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const loginBox = document.getElementById('loginBox');
            if (loginBox && !document.getElementById('loginErrorMsg')) {
                const errorDiv = document.createElement('div');
                errorDiv.id = 'loginErrorMsg';
                errorDiv.style = 'color:#d00;margin-bottom:16px;padding:8px;background:#fff8f8;border-radius:6px;font-size:14px;';
                errorDiv.textContent = message;
                loginBox.insertBefore(errorDiv, loginBox.firstChild.nextSibling);
            }
        }
        modal.style.display = 'flex';
    }
    
    // å…³é—­ç™»å½•æ¨¡æ€æ¡†
    function closeLoginModal() {
        let modal = document.getElementById('loginModal');
        if(modal) modal.remove();
    }
    
    // ç™»å½•ç”¨æˆ·
    function loginUser() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        fetch('/api/login', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials: 'include',
            body:JSON.stringify({username,password})
        }).then(r=>r.json()).then(d=>{
            if(d.success) { 
                closeLoginModal(); 
                location.reload();
            }
            else document.getElementById('loginMsg').textContent = d.msg||'ç™»å½•å¤±è´¥';
        });
    }
    
    // æ˜¾ç¤ºæ³¨å†Œæ¡†
    function showRegisterBox() {
        const box = document.getElementById('loginBox');
        if(box) {
            box.innerHTML = `
                <h3 style='margin-bottom:18px;'>ç”¨æˆ·æ³¨å†Œ</h3>
                <input id='regUsername' class='form-input' style='margin-bottom:12px;' placeholder='ç”¨æˆ·å'>
                <input id='regPassword' class='form-input' type='password' style='margin-bottom:12px;' placeholder='å¯†ç '>
                <input id='regPassword2' class='form-input' type='password' style='margin-bottom:18px;' placeholder='é‡å¤å¯†ç '>
                <div style='text-align:right;'>
                    <button class='btn btn-outline' onclick='closeLoginModal()'>å–æ¶ˆ</button>
                    <button class='btn btn-primary' onclick='registerUser()'>æ³¨å†Œ</button>
                    <button class='btn btn-link' style='margin-left:8px;' onclick='showLoginBox()'>è¿”å›ç™»å½•</button>
                </div>
                <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
            `;
        }
    }
    
    // æ˜¾ç¤ºç™»å½•æ¡†
    function showLoginBox() {
        const box = document.getElementById('loginBox');
        if(box) {
            box.innerHTML = `
                <h3 style='margin-bottom:18px;'>ç”¨æˆ·ç™»å½•</h3>
                <input id='loginUsername' class='form-input' style='margin-bottom:12px;' placeholder='ç”¨æˆ·å'>
                <input id='loginPassword' class='form-input' type='password' style='margin-bottom:18px;' placeholder='å¯†ç '>
                <div style='text-align:right;'>
                    <button class='btn btn-outline' onclick='closeLoginModal()'>å–æ¶ˆ</button>
                    <button class='btn btn-primary' onclick='loginUser()'>ç™»å½•</button>
                    <button class='btn btn-link' style='margin-left:8px;' onclick='showRegisterBox()'>æ³¨å†Œ</button>
                </div>
                <div id='loginMsg' style='color:#d00;font-size:13px;margin-top:10px;'></div>
            `;
        }
    }
    
    // æ³¨å†Œæ–°ç”¨æˆ·
    function registerUser() {
        const username = document.getElementById('regUsername').value.trim();
        const password = document.getElementById('regPassword').value;
        const password2 = document.getElementById('regPassword2').value;
        if(!username || !password) { document.getElementById('loginMsg').textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'; return; }
        if(password !== password2) { document.getElementById('loginMsg').textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'; return; }
        fetch('/api/register', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials: 'include',
            body:JSON.stringify({username,password})
        }).then(r=>r.json()).then(d=>{
            if(d.success) {
                // æ³¨å†ŒæˆåŠŸè‡ªåŠ¨ç™»å½•
                fetch('/api/login', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials: 'include',
                    body:JSON.stringify({username,password})
                }).then(r=>r.json()).then(d2=>{
                    if(d2.success) { 
                        closeLoginModal();
                        location.reload();
                    }
                    else document.getElementById('loginMsg').textContent = 'æ³¨å†ŒæˆåŠŸä½†è‡ªåŠ¨ç™»å½•å¤±è´¥';
                });
            } else {
                document.getElementById('loginMsg').textContent = d.msg||'æ³¨å†Œå¤±è´¥';
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–é¡µé¢
        renderUserBox();
        loadFriends();
        loadFriendRequests();
        
        // æ ‡ç­¾åˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
            });
        });
        
        // æœç´¢æŒ‰é’®äº‹ä»¶
        document.getElementById('searchBtn').addEventListener('click', searchUsers);
        
        // å›è½¦æœç´¢
        document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });
        
        // å®šæœŸæ£€æŸ¥æœªè¯»æ¶ˆæ¯
        checkUnreadMessages();
        setInterval(checkUnreadMessages, 10000);
    });
    
    // åŠ è½½å¥½å‹åˆ—è¡¨
    function loadFriends() {
        fetch('/api/friends', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            const friendsList = document.getElementById('friendsList');
            
            if (data.success && data.friends.length > 0) {
                let html = '';
                data.friends.forEach(friend => {
                    html += `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${friend.username[0].toUpperCase()}</div>
                            <div>
                                <div>${friend.username}</div>
                                <div id="unread-${friend.id}" class="unread-badge" style="display:none;"></div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <a href="/chat/${friend.id}" class="btn btn-small btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right:4px;">
                                    <path d="M4 4H20V16H5.17L4 17.17V4ZM4 2C2.9 2 2.01 2.9 2.01 4L2 22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2H4Z" fill="currentColor"/>
                                </svg>
                                èŠå¤©
                            </a>
                            <button class="btn btn-small btn-outline" onclick="deleteFriend(${friend.id})">åˆ é™¤å¥½å‹</button>
                        </div>
                    </div>
                    `;
                });
                friendsList.innerHTML = html;
            } else {
                friendsList.innerHTML = '<div class="empty-state">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ å¥½å‹</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('friendsList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
        });
    }
    
    // åŠ è½½å¥½å‹è¯·æ±‚
    function loadFriendRequests() {
        fetch('/api/friend-requests', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            const requestsList = document.getElementById('requestsList');
            
            if (data.success && data.requests.length > 0) {
                let html = '';
                data.requests.forEach(request => {
                    html += `
                    <div class="friend-request">
                        <div class="friend-info">
                            <div class="friend-avatar">${request.sender_name[0].toUpperCase()}</div>
                            <div>
                                <div>${request.sender_name}</div>
                                <div style="font-size: 12px; color: #666;">${request.created_at}</div>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn btn-small btn-primary" onclick="respondFriendRequest(${request.id}, 'accept')">æ¥å—</button>
                            <button class="btn btn-small btn-outline" onclick="respondFriendRequest(${request.id}, 'reject')">æ‹’ç»</button>
                        </div>
                    </div>
                    `;
                });
                requestsList.innerHTML = html;
                
                // æ›´æ–°è¯·æ±‚æ•°é‡æ ‡è®°
                document.getElementById('requestCount').textContent = data.requests.length;
                document.getElementById('requestCount').style.display = 'inline-block';
            } else {
                requestsList.innerHTML = '<div class="empty-state">æ²¡æœ‰å¾…å¤„ç†çš„å¥½å‹è¯·æ±‚</div>';
                document.getElementById('requestCount').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('requestsList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
        });
    }
    
    // æœç´¢ç”¨æˆ·
    function searchUsers() {
        const keyword = document.getElementById('searchKeyword').value.trim();
        if (keyword.length < 2) {
            alert('è¯·è¾“å…¥è‡³å°‘2ä¸ªå­—ç¬¦');
            return;
        }
        
        document.getElementById('searchResults').innerHTML = '<p class="subtitle">æœç´¢ä¸­...</p>';
        
        fetch(`/api/search-users?keyword=${encodeURIComponent(keyword)}`, {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            const resultsContainer = document.getElementById('searchResults');
            
            if (data.success && data.users.length > 0) {
                let html = '';
                data.users.forEach(user => {
                    let actionBtn = '';
                    
                    if (user.is_friend) {
                        actionBtn = `<button class="btn btn-small btn-outline" disabled>å·²æ˜¯å¥½å‹</button>`;
                    } else if (user.request_sent) {
                        actionBtn = `<button class="btn btn-small btn-outline" disabled>å·²å‘é€è¯·æ±‚</button>`;
                    } else if (user.request_received) {
                        actionBtn = `<button class="btn btn-small btn-primary" onclick="switchToRequestsTab()">æŸ¥çœ‹è¯·æ±‚</button>`;
                    } else {
                        actionBtn = `<button class="btn btn-small btn-primary" onclick="sendFriendRequest(${user.id})">æ·»åŠ å¥½å‹</button>`;
                    }
                    
                    html += `
                    <div class="search-result-item">
                        <div class="friend-info">
                            <div class="friend-avatar">${user.username[0].toUpperCase()}</div>
                            <div>${user.username}</div>
                        </div>
                        ${actionBtn}
                    </div>
                    `;
                });
                resultsContainer.innerHTML = html;
            } else if (data.success && data.users.length === 0) {
                resultsContainer.innerHTML = '<div class="empty-state">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</div>';
            } else {
                resultsContainer.innerHTML = `<div class="empty-state">${data.msg || 'æœç´¢å¤±è´¥'}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('searchResults').innerHTML = '<div class="empty-state">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
        });
    }
    
    // å‘é€å¥½å‹è¯·æ±‚
    function sendFriendRequest(receiverId) {
        fetch('/api/send-friend-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                receiver_id: receiverId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.msg);
                searchUsers(); // åˆ·æ–°æœç´¢ç»“æœ
            } else {
                alert(data.msg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('å‘é€è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    // å›åº”å¥½å‹è¯·æ±‚
    function respondFriendRequest(requestId, action) {
        fetch('/api/respond-friend-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                request_id: requestId,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.msg);
                loadFriendRequests(); // åˆ·æ–°è¯·æ±‚åˆ—è¡¨
                if (action === 'accept') {
                    loadFriends(); // å¦‚æœæ¥å—äº†è¯·æ±‚ï¼Œåˆ·æ–°å¥½å‹åˆ—è¡¨
                }
            } else {
                alert(data.msg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('å¤„ç†è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    // åˆ é™¤å¥½å‹
    function deleteFriend(friendId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¥½å‹å—ï¼Ÿ')) {
            return;
        }
        
        fetch('/api/delete-friend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                friend_id: friendId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.msg);
                loadFriends(); // åˆ·æ–°å¥½å‹åˆ—è¡¨
            } else {
                alert(data.msg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('åˆ é™¤å¥½å‹å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    // åˆ‡æ¢åˆ°è¯·æ±‚æ ‡ç­¾
    function switchToRequestsTab() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector('.tab[data-tab="requests"]').classList.add('active');
        document.getElementById('requests-tab').classList.add('active');
    }
    
    // å¯åŠ¨èŠå¤©
    function startChat(friendId) {
        window.location.href = `/chat/${friendId}`;
    }
    
    // æ£€æŸ¥æœªè¯»æ¶ˆæ¯
    function checkUnreadMessages() {
        fetch('/api/unread-messages', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ›´æ–°å…¨å±€æœªè¯»æ¶ˆæ¯æ•°é‡
                updateUnreadCount(data.unread.total);
                
                // æ›´æ–°æ¯ä¸ªå¥½å‹çš„æœªè¯»æ¶ˆæ¯æ•°
                const bySender = data.unread.by_sender || {};
                for (const senderId in bySender) {
                    const unreadBadge = document.getElementById(`unread-${senderId}`);
                    if (unreadBadge) {
                        unreadBadge.textContent = bySender[senderId];
                        unreadBadge.style.display = 'inline-block';
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking unread messages:', error);
        });
    }
    
    // æ›´æ–°æœªè¯»æ¶ˆæ¯æ•°é‡
    function updateUnreadCount(count) {
        // å¦‚æœæœ‰å¯¼èˆªæ ä¸Šçš„æ¶ˆæ¯é€šçŸ¥å›¾æ ‡ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°
        if (count > 0) {
            // åˆ›å»ºæˆ–æ›´æ–°å¯¼èˆªæ æ¶ˆæ¯é€šçŸ¥
            let msgNotif = document.getElementById('navMsgNotif');
            if (!msgNotif) {
                msgNotif = document.createElement('span');
                msgNotif.id = 'navMsgNotif';
                msgNotif.className = 'nav-notification';
                document.querySelector('.nav-links a[href="/friends"]').appendChild(msgNotif);
            }
            msgNotif.textContent = count > 99 ? '99+' : count;
        } else {
            // ç§»é™¤é€šçŸ¥
            const msgNotif = document.getElementById('navMsgNotif');
            if (msgNotif) msgNotif.remove();
        }
    }
    </script>
</body>
</html> 