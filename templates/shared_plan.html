<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plan.title }} - åˆ†äº«çš„æ—…è¡Œè®¡åˆ’ - Travel Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <!-- é«˜å¾·åœ°å›¾API -->
    <script type="text/javascript" async defer src="https://webapi.amap.com/maps?v=2.0&key={{ config.AMAP_WEB_KEY }}&plugin=AMap.Scale,AMap.ToolBar,AMap.Driving"></script>
    <style>
        /* åˆ†äº«é¡µé¢ç‰¹æœ‰æ ·å¼ */
        .shared-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .shared-notice h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .shared-notice p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ç§»é™¤ç¼–è¾‘æŒ‰é’®ç­‰éœ€è¦æƒé™çš„åŠŸèƒ½ */
        .itinerary-controls {
            display: none;
        }
        
        .plan-actions {
            display: none;
        }
        
        /* éšè—ä¸éœ€è¦çš„åŠŸèƒ½ */
        #travelNotesSection {
            display: none;
        }
        
        /* ç¡®ä¿æ—¶é—´çº¿æ ·å¼ä¸åŸç‰ˆä¸€è‡´ */
        .timeline {
            position: relative;
            padding: 0;
        }
        
        .timeline-day {
            margin-bottom: 32px;
            border-bottom: 1px solid var(--divider-color, #e0e0e0);
            padding-bottom: 24px;
        }
        
        .timeline-day:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .timeline-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background-color: var(--background-color, #f8f9fa);
            border-radius: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .timeline-items {
            padding-left: 16px;
        }
        
        .timeline-item {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background-color: var(--surface-color, #fff);
            border-radius: 8px;
            border: 1px solid var(--divider-color, #e0e0e0);
            transition: all 0.2s ease;
        }
        
        .timeline-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: var(--primary-color, #007AFF);
        }
        
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        
        .item-time {
            flex-shrink: 0;
            width: 80px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color, #007AFF);
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-content h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }
        
        .item-content p {
            margin: 4px 0;
            color: var(--text-secondary, #7f8c8d);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .item-location {
            font-size: 14px;
            color: var(--text-secondary, #7f8c8d);
            margin: 4px 0;
        }
        
        .item-cost {
            color: var(--primary-color, #007AFF);
            font-size: 14px;
            font-weight: 600;
        }
        
        /* è¦†ç›–åŸæœ‰çš„activityæ ·å¼ï¼Œä½¿ç”¨timelineæ ·å¼ */
        .activity-item {
            display: none;
        }
        
        .activity-info {
            display: none;
        }
        
        .activity-time {
            display: none;
        }
        
        /* è¡ŒåŠ¨å·å¬åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        .cta-section {
            text-align: center;
            padding: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            margin-top: 32px;
        }
        
        .cta-section h3 {
            margin-bottom: 16px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .cta-section p {
            margin-bottom: 24px;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .cta-btn {
            background: white;
            color: #667eea;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }
        
        .cta-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">ğŸŒ Travel Agent</a>
            <div class="nav-links">
                <a href="/">é¦–é¡µ</a>
                <a href="/plans">æˆ‘çš„è®¡åˆ’</a>
                <a href="/notes">æ¸¸è®°</a>
                <a href="/expenses">å¼€é”€</a>
                <a href="/moments">åŠ¨æ€</a>
                <a href="/friends">å¥½å‹</a>
                <a href="/reports">æŠ¥å‘Š</a>
                <a href="/about">å…³äº</a>
            </div>
            <div class="nav-user">
                <a href="/" class="btn btn-small btn-primary">è¿›å…¥ Travel Agent</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-container">
        <!-- åˆ†äº«æç¤º -->
        <div class="shared-notice">
            <h3>ğŸ”— è¿™æ˜¯ä¸€ä¸ªåˆ†äº«çš„æ—…è¡Œè®¡åˆ’</h3>
            <p>ç”± {{ plan.user.username }} åˆ†äº« â€¢ æŸ¥çœ‹ä»–ä»¬çš„ç²¾å½©è¡Œç¨‹å®‰æ’</p>
        </div>

        <!-- Appleé£æ ¼é¡¶éƒ¨è®¡åˆ’ä¿¡æ¯å¡ç‰‡ - ä½¿ç”¨ä¸plan.htmlç›¸åŒçš„æ ·å¼ -->
        <div class="plan-header-apple">
            <div class="plan-header-main">
                <h1 class="plan-title">{{ plan.title }}</h1>
                <div class="plan-tags">
                    <span class="tag tag-primary">{{ plan.travel_theme }}</span>
                    <span class="tag tag-secondary">{{ plan.transport_mode }}</span>
                    {% if plan.ai_generated %}
                    <span class="tag tag-warning">AIç”Ÿæˆ</span>
                    {% endif %}
                </div>
            </div>
            <div class="plan-header-info">
                <div>
                    <div class="info-label">å‡ºè¡Œæ—¥æœŸ</div>
                    <div class="info-value">{{ plan.start_date }} è‡³ {{ plan.end_date }}</div>
                </div>
                <div>
                    <div class="info-label">æ€»å¤©æ•°</div>
                    <div class="info-value">{{ plan.total_days }}å¤©</div>
                </div>
                <div>
                    <div class="info-label">é¢„ç®—èŒƒå›´</div>
                    <div class="info-value">Â¥{{ plan.budget_min }} - Â¥{{ plan.budget_max }}</div>
                </div>
                <div>
                    <div class="info-label">è®¡åˆ’çŠ¶æ€</div>
                    <div class="info-value">
                        <span class="status-badge status-{{ plan.status }}">
                            {% if plan.status == 'draft' %}è‰ç¨¿{% elif plan.status == 'confirmed' %}å·²ç¡®è®¤{% elif plan.status == 'completed' %}å·²å®Œæˆ{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-layout">
            <!-- åœ°å›¾åŒºåŸŸ -->
            <div class="map-section">
                <div class="card map-card">
                    <div class="card-header">
                        <h3 class="title-medium">ğŸ“ è¡Œç¨‹åœ°å›¾</h3>
                        <div class="map-controls">
                            <button id="showRouteBtn" class="btn btn-small btn-primary">æ˜¾ç¤ºè·¯çº¿</button>
                            <button id="refreshRouteBtn" class="btn btn-small btn-outline">åˆ·æ–°è·¯çº¿</button>
                            <button id="fitViewBtn" class="btn btn-small btn-secondary">é€‚åº”è§†å›¾</button>
                        </div>
                    </div>
                    <div id="mapContainer" class="map-container"></div>
                    <div id="routeInfo" class="route-info-container"></div>
                </div>
            </div>

            <!-- è¡Œç¨‹è¯¦æƒ… -->
            <div class="itinerary-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="title-medium">ğŸ“… è¯¦ç»†è¡Œç¨‹</h3>
                    </div>
                    
                    <div class="itinerary-content">
                        <div id="itineraryTimeline" class="timeline">
                            <!-- åŠ¨æ€åŠ è½½è¡Œç¨‹å†…å®¹ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-section">
            <div class="card">
                <h3 class="title-medium">ğŸ“Š è¡Œç¨‹ç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCost">-</div>
                        <div class="stat-label">æ€»è´¹ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalDistance">-</div>
                        <div class="stat-label">æ€»è·ç¦»</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalLocations">-</div>
                        <div class="stat-label">åœ°ç‚¹æ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgDailyCost">-</div>
                        <div class="stat-label">æ—¥å‡è´¹ç”¨</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¡ŒåŠ¨å·å¬ -->
        <div class="cta-section">
            <h3>å–œæ¬¢è¿™ä¸ªæ—…è¡Œè®¡åˆ’ï¼Ÿ</h3>
            <p>åŠ å…¥ Travel Agentï¼Œåˆ›å»ºå±äºä½ è‡ªå·±çš„ç²¾å½©æ—…è¡Œè®¡åˆ’ï¼</p>
            <a href="/" class="cta-btn">ç«‹å³å¼€å§‹è§„åˆ’ â†’</a>
        </div>
    </div>

    <!-- åŠ è½½ä¸­é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ä¼ é€’è®¡åˆ’IDå’Œåˆ†äº«tokenç»™JS
        window.PLAN_ID = parseInt("{{ plan.id }}");
        window.SHARE_TOKEN = "{{ request.view_args.share_token }}";
        window.IS_SHARED_VIEW = true;
        
        // ç®€åŒ–ç‰ˆåœ°å›¾åŠŸèƒ½
        let map = null;
        let planData = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initSharedPlan();
        });

        async function initSharedPlan() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoading(true);
                
                // è·å–åˆ†äº«è®¡åˆ’æ•°æ®
                await loadSharedPlanData();
                
                // åˆå§‹åŒ–åœ°å›¾
                initMap();
                
                // æ¸²æŸ“è¡Œç¨‹æ—¶é—´çº¿
                renderItinerary();
                
                // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                calculateStats();
                
            } catch (error) {
                console.error('åŠ è½½åˆ†äº«è®¡åˆ’å¤±è´¥:', error);
                showError('åŠ è½½è®¡åˆ’æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            } finally {
                showLoading(false);
            }
        }

        async function loadSharedPlanData() {
            const response = await fetch(`/api/shared-plan/${window.PLAN_ID}/${window.SHARE_TOKEN}`);
            if (!response.ok) {
                throw new Error('è·å–åˆ†äº«è®¡åˆ’æ•°æ®å¤±è´¥');
            }
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.msg || 'è·å–è®¡åˆ’æ•°æ®å¤±è´¥');
            }
            planData = data;
        }

        function renderItinerary() {
            const timeline = document.getElementById('itineraryTimeline');
            if (!planData.itineraries || planData.itineraries.length === 0) {
                timeline.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— è¡Œç¨‹å®‰æ’</p>';
                return;
            }

            timeline.innerHTML = planData.itineraries.map(day => {
                let itemsHtml = '';
                if (day.items && day.items.length > 0) {
                    itemsHtml = day.items.map(item => `
                        <div class="timeline-item">
                            <div class="item-time">${item.start_time}</div>
                            <div class="item-content">
                                <h4>${item.title}</h4>
                                <p class="item-location"><i class="fas fa-map-marker-alt"></i> ${item.location || 'æœªè®¾ç½®åœ°ç‚¹'}</p>
                                ${item.description ? `<p>${item.description}</p>` : ''}
                                ${item.estimated_cost > 0 ? `<p class="item-cost"><i class="fas fa-yen-sign"></i> é¢„ä¼°è´¹ç”¨: Â¥${item.estimated_cost}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    itemsHtml = '<div style="color: #999; font-style: italic; text-align: center; padding: 20px;">æš‚æ— å…·ä½“å®‰æ’</div>';
                }

                return `
                    <div class="timeline-day">
                        <div class="timeline-header">
                            ç¬¬${day.day_number}å¤© - ${day.date} ${day.theme ? `(${day.theme})` : ''}
                        </div>
                        <div class="timeline-items">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateStats() {
            if (!planData.itineraries) return;

            let totalCost = 0;
            let totalLocations = 0;
            const locations = new Set();

            planData.itineraries.forEach(day => {
                if (day.items) {
                    day.items.forEach(item => {
                        if (item.estimated_cost) {
                            totalCost += item.estimated_cost;
                        }
                        if (item.location) {
                            locations.add(item.location);
                        }
                    });
                }
            });

            totalLocations = locations.size;
            const avgDailyCost = planData.total_days > 0 ? Math.round(totalCost / planData.total_days) : 0;

            document.getElementById('totalCost').textContent = totalCost > 0 ? `Â¥${totalCost.toLocaleString()}` : '-';
            document.getElementById('totalDistance').textContent = '-'; // éœ€è¦è·¯çº¿è®¡ç®—
            document.getElementById('totalLocations').textContent = totalLocations;
            document.getElementById('avgDailyCost').textContent = avgDailyCost > 0 ? `Â¥${avgDailyCost.toLocaleString()}` : '-';
        }

        function initMap() {
            if (typeof AMap === 'undefined') {
                document.getElementById('mapContainer').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666; background-color: #f5f5f5; border-radius: 8px;">
                        <h3>ğŸ—ºï¸ åœ°å›¾åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•åŠ è½½é«˜å¾·åœ°å›¾API</p>
                    </div>
                `;
                return;
            }

            map = new AMap.Map('mapContainer', {
                zoom: 10,
                center: [116.397428, 39.90923]
            });

            // æ·»åŠ åœ°å›¾æ ‡è®°
            addMapMarkers();
        }

        function addMapMarkers() {
            if (!map || !planData.itineraries) return;

            const markers = [];
            planData.itineraries.forEach((day, dayIndex) => {
                if (day.items) {
                    day.items.forEach((item, itemIndex) => {
                        if (item.latitude && item.longitude) {
                            const marker = new AMap.Marker({
                                position: [item.longitude, item.latitude],
                                title: item.title
                            });
                            
                            const infoWindow = new AMap.InfoWindow({
                                content: `
                                    <div style="padding: 10px;">
                                        <h4 style="margin: 0 0 5px 0;">${item.title}</h4>
                                        <p style="margin: 0; color: #666;">ç¬¬${day.day_number}å¤© - ${item.start_time}</p>
                                        <p style="margin: 5px 0 0 0;">${item.location}</p>
                                    </div>
                                `
                            });
                            
                            marker.on('click', function() {
                                infoWindow.open(map, marker.getPosition());
                            });
                            
                            markers.push(marker);
                        }
                    });
                }
            });

            if (markers.length > 0) {
                map.add(markers);
                map.setFitView(markers);
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        function showError(message) {
            console.error(message);
            // ç®€å•çš„é”™è¯¯æ˜¾ç¤º
            alert(message);
        }

        // åœ°å›¾æ§åˆ¶æŒ‰é’®
        document.getElementById('showRouteBtn')?.addEventListener('click', function() {
            if (map) {
                // ç®€åŒ–ç‰ˆè·¯çº¿æ˜¾ç¤º
                this.textContent = this.textContent.includes('æ˜¾ç¤º') ? 'éšè—è·¯çº¿' : 'æ˜¾ç¤ºè·¯çº¿';
            }
        });

        document.getElementById('fitViewBtn')?.addEventListener('click', function() {
            if (map) {
                map.setFitView();
            }
        });
    </script>
</body>
</html> 