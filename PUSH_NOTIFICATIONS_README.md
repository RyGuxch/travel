# 🔔 Web推送通知功能使用说明

## 功能概述

Travel Agent现在支持Web推送通知功能！当有好友发送消息时，您将收到实时的浏览器推送通知，即使在其他标签页或应用中也能及时收到提醒。

## 主要特性

- ✅ **实时消息推送**: 好友发送消息时立即收到通知
- ✅ **跨平台支持**: 支持桌面和移动设备浏览器
- ✅ **离线通知**: 即使不在Travel Agent页面也能收到通知
- ✅ **智能管理**: 自动处理失效订阅，优化性能
- ✅ **隐私保护**: 通知数据加密传输，保护用户隐私

## 如何使用

### 1. 启用通知

1. 访问好友管理页面 (`/friends`)
2. 在页面顶部找到"消息推送通知"区域
3. 点击"启用通知"按钮
4. 在浏览器弹出的权限请求中选择"允许"

### 2. 测试功能

- 在好友管理页面点击"测试通知"按钮验证功能是否正常

### 3. 接收消息通知

启用后，当有好友发送消息时，您将收到包含以下信息的通知：
- 发送者姓名
- 消息内容预览（前50个字符）
- 点击通知可直接跳转到聊天页面

## 技术实现

### 前端组件

- **Service Worker** (`/static/js/sw.js`): 处理推送消息和通知显示
- **通知管理器** (`/static/js/notifications.js`): 管理订阅和权限
- **UI集成**: 在好友页面集成通知控制界面

### 后端API

- `GET /api/vapid-public-key`: 获取VAPID公钥
- `POST /api/save-subscription`: 保存推送订阅
- `POST /api/remove-subscription`: 移除推送订阅
- `POST /api/test-notification`: 发送测试通知
- `GET /api/notification-settings`: 获取通知设置

### 数据库

新增 `push_subscriptions` 表存储用户推送订阅信息：
- 用户ID关联
- 推送端点URL
- 加密密钥
- 订阅状态管理

## 浏览器兼容性

### 支持的浏览器
- ✅ Chrome 50+
- ✅ Firefox 44+
- ✅ Safari 16+ (macOS 13+)
- ✅ Edge 17+
- ✅ Opera 37+

### 移动端支持
- ✅ Android Chrome
- ✅ Android Firefox
- ✅ iOS Safari 16.4+ (iOS 16.4+)

## 部署配置

### Railway部署

推送通知功能已完全兼容Railway部署环境：

1. **自动数据库迁移**: 部署时自动创建推送订阅表
2. **环境变量配置**: 可选配置VAPID密钥（已提供默认值）
3. **HTTPS支持**: Railway自动提供HTTPS，满足推送通知要求

### 可选环境变量

```bash
# VAPID密钥配置（可选，已有默认值）
VAPID_PRIVATE_KEY=your_private_key
VAPID_PUBLIC_KEY=your_public_key
VAPID_SUBJECT=mailto:your_email@domain.com
```

## 故障排除

### 常见问题

1. **通知权限被拒绝**
   - 在浏览器设置中手动允许通知权限
   - 清除浏览器数据后重新授权

2. **Service Worker注册失败**
   - 确保使用HTTPS连接（本地开发可使用localhost）
   - 检查浏览器控制台错误信息

3. **推送订阅失败**
   - 检查网络连接
   - 确认已登录用户账户

4. **收不到推送通知**
   - 验证通知权限状态
   - 检查浏览器通知设置
   - 确认推送订阅状态

### 调试工具

在好友管理页面提供了通知功能的测试和调试：
- 实时状态监控
- 权限管理测试
- 本地和服务器推送测试

## 安全考虑

1. **数据加密**: 推送消息内容经过加密传输
2. **权限控制**: 仅好友间可发送推送通知
3. **订阅管理**: 自动清理失效订阅，防止资源浪费
4. **隐私保护**: 不存储敏感的推送内容

## 更新日志

### v1.0.0 (当前版本)
- ✅ 基础推送通知功能
- ✅ 好友消息推送
- ✅ 浏览器兼容性支持
- ✅ Railway部署兼容
- ✅ 测试和调试工具

### 计划功能
- 🔄 推送通知个性化设置
- 🔄 群组消息推送
- 🔄 系统通知推送
- 🔄 推送统计和分析

## 技术支持

如遇到问题，请：
1. 首先访问测试页面进行自诊断
2. 检查浏览器控制台错误信息
3. 确认浏览器和设备兼容性
4. 联系技术支持团队

---

**注意**: Web推送通知需要HTTPS环境才能正常工作。在本地开发时，请使用 `localhost` 或配置HTTPS证书。 